<!-- 商品详情页结构 -->
<!-- 加载动画组件 -->
<loading visible="{{isLoading}}"></loading>

<view class="detail-container">
  <!-- 商品内容（加载完成后显示） -->
  <view wx:if="{{!isLoading}}">

    
    <!-- 商品主视觉区：占满宽度的商品封面图 -->
    <view class="product-visual-section">
      <!-- 商品封面图：关联数据库cover-image字段 -->
      <!-- 修复：将mode改为widthFix，实现等比例自适应 -->
      <image class="product-cover" src="{{product['cover-image'] || '/assets/images/search.svg'}}" mode="widthFix"></image>
      <!-- 促销标签 -->
      <view wx:if="{{product['original-price'] > product.price}}" class="promotion-tag">
        <text class="tag-text">促销</text>
      </view>
    </view>
    

    
    <!-- 商品核心信息区 -->
    <view class="product-core-info">
      <!-- 商品名称：加粗 -->
      <view class="product-name">{{product.name}}</view>
      <!-- 商品详情：用rich-text解析富文本，去掉HTML标签显示 -->
      <rich-text class="product-detail" nodes="{{product.detail}}"></rich-text>
      <!-- 商品价格区域 -->
      <view class="product-price-section">
        <!-- 标红显示的价格：关联数据库price字段 -->
        <text class="current-price">¥{{product.price}}</text>
        <!-- 划横线的原价：关联数据库original-price字段 -->
        <text class="original-price" wx:if="{{product['original-price'] > 0}}">¥{{product['original-price']}}</text>
      </view>
      
      <!-- 商品库存显示（添加极致鲁棒的容错逻辑） -->
      <!-- 容错逻辑说明：
        1. 第一层保障：JS层面已通过parseStockField方法处理，确保stock和lockedStock为数字
        2. 第二层保障：WXML层面添加容错，应对任何意外情况
        3. 计算逻辑：可用库存 = 总库存 - 锁定库存
      -->
      <view class="product-stock">
        <text class="stock-label">库存：</text>
        <text class="stock-value">
          {{ (product && product.stock ? product.stock : 0) - (product && product.lockedStock ? product.lockedStock : 0) }} 件
        </text>
      </view>
      
      </view>
    
    <!-- 图文详情区域 -->
    <view class="product-detail-section">
      <view class="section-title">图文详情</view>
      <!-- 核心：只保留rich-text，去掉多余的嵌套/样式干扰 -->
      <view class="tuwen-detail-container" wx:if="{{product.tuwen_detail}}">
        <rich-text nodes="{{product.tuwen_detail}}"></rich-text>
      </view>
      <!-- 无内容时的提示 -->
      <view class="no-image" wx:else>
        <text class="no-image-text">暂无图文详情</text>
      </view>
    </view>
    
    <!-- 价格说明文本框 -->
    <view class="price-description">
      <view class="price-description-title">价格说明：</view>
      <view class="price-description-content">
        <view class="price-description-item">
          <view class="price-description-subtitle">·划线价格</view>
          <view class="price-description-text">商品的专柜价、吊牌价、正品零售价、厂商指导价或该商品的曾经展示过的销售价等，并非原价，仅供参考。</view>
        </view>
        <view class="price-description-item">
          <view class="price-description-subtitle">·未划线价格</view>
          <view class="price-description-text">商品的实时价格，不因表述的差异改变性质。具体成交价格根据商品参加活动，或使用优惠券、积分等发生变化，最终以订单结算页价格为准。</view>
        </view>
        <view class="price-description-item">
          <view class="price-description-subtitle">·商品详情（含主图）</view>
          <view class="price-description-text">以图片或文字形式标注的一口价、促销价、优惠价等价格可能是在使用优惠券、满减或特定优惠活动和时段等情形下的价格，具体请以结算页面的标价、优惠条件或活动规则为准。</view>
        </view>
      </view>
    </view>
    

    
    <!-- 底部固定操作栏 -->
    <view class="bottom-action-bar">
      <view class="nav-buttons">
        <view class="nav-btn" bindtap="navigateToHome">
          <image class="nav-btn-icon" src="cloud://fuxididai8888-5g9tptvfb7056681.6675-fuxididai8888-5g9tptvfb7056681-1397228946/xiaotubiao/全部.png"></image>
          <text class="nav-btn-text">首页</text>
        </view>
        <view class="nav-btn" bindtap="navigateToCart">
          <image class="nav-btn-icon" src="cloud://fuxididai8888-5g9tptvfb7056681.6675-fuxididai8888-5g9tptvfb7056681-1397228946/xiaotubiao/购物车.png"></image>
          <text class="nav-btn-text">购物车</text>
        </view>
      </view>
      <view class="action-buttons">
        <view class="action-btn add-cart-btn" bindtap="showSpecSelector">
          加入购物车
        </view>
        <view class="action-btn buy-now-btn" bindtap="onBuyNow">
          立即购买
        </view>
      </view>
    </view>
    
    <!-- 规格选择弹窗 -->
    <view class="spec-modal" wx:if="{{showSpecModal}}">
      <view class="modal-overlay" bindtap="closeSpecModal"></view>
      <view class="modal-content">
        <!-- 商品信息 -->
        <view class="modal-header">
          <!-- 缩小图片尺寸 -->
          <image class="modal-product-image" src="{{product['cover-image'] || '/assets/images/search.svg'}}" mode="aspectFit"></image>
          <view class="modal-price-section">
            <text class="modal-product-name">{{product.name}}</text>
            <rich-text class="modal-product-detail" nodes="{{product.detail}}"></rich-text>
            <text class="modal-current-price">¥{{product.price}}</text>
          </view>
          <view class="close-btn" bindtap="closeSpecModal">×</view>
        </view>
        
        <!-- 数量选择 -->
        <view class="quantity-selector">
          <text class="quantity-title">购买数量</text>
          <view class="quantity-control">
            <view class="quantity-btn minus {{quantity <= 0 ? 'disabled' : ''}}" bindtap="decreaseQuantity">-</view>
            <input class="quantity-input" type="number" value="{{quantity}}" bindinput="onQuantityInput" />
            <view class="quantity-btn plus {{quantity >= 999 ? 'disabled' : ''}}" bindtap="increaseQuantity">+</view>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="modal-actions">
          <button class="modal-add-cart-btn" type="primary" bindtap="onAddToCart">加入购物车</button>
          <button class="modal-buy-now-btn" type="warn" bindtap="onBuyNow">立即购买</button>
        </view>
      </view>
    </view>
  </view>
</view>