<!-- 购物车页面 -->
<!-- 加载动画组件 -->
<loading visible="{{loading}}"></loading>
<view class="cart-container">
  <!-- 购物车头部 -->
  <view class="cart-header">
    <view class="manage-btn" bindtap="toggleManageMode">
      {{isManageMode ? '完成' : '管理'}}
    </view>
  </view>

  <!-- 购物车为空状态 -->
  <view class="empty-cart" wx:if="{{!cartItems || cartItems.length === 0}}">
    <view class="empty-icon-container">
      <!-- 柔和的空购物车图标 -->
      <view class="soft-empty-icon">
        <image class="empty-cart-icon" src="cloud://fuxididai8888-5g9tptvfb7056681.6675-fuxididai8888-5g9tptvfb7056681-1397228946/xiaotubiao/空购物车.png" mode="aspectFit"></image>
      </view>
    </view>
    <view class="empty-text">购物车还是空的</view>
    <view class="empty-subtext">还没选水？看看推荐商品吧～</view>
    <button class="go-shopping-btn" bindtap="goShopping">去购物</button>
    
    <!-- 推荐商品区域 -->
    <view class="recommend-section">
      <!-- 猜你喜欢标题 -->
      <view class="guess-like-title">猜你喜欢</view>
      <view class="hot-products">
        <view class="product-item" wx:for="{{recommendProducts}}" wx:key="productId">
          <view class="product-content" bindtap="onProductClick" data-product-id="{{item.productId}}">
            <image class="product-image" src="{{item.cover_image || 'cloud://fuxididai8888-5g9tptvfb7056681.6675-fuxididai8888-5g9tptvfb7056681-1397228946/xiaotubiao/空购物车.png'}}" mode="widthFix"></image>
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              <view class="product-bottom">
                <text class="product-spec">{{item.spec || '无'}}</text>
                <text class="product-price">¥{{item.price}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 购物车商品列表 -->
  <view class="cart-list" wx:if="{{cartItems && cartItems.length > 0}}">
    <block wx:for="{{cartItems}}" wx:key="_id">
      <!-- 购物车商品项容器：参照示例布局，适配项目字段 -->
      <view class="cart-item">
        <!-- 1. 勾选按钮区 -->
        <view class="cart-item-check">
          <checkbox checked="{{item.checked}}" bindtap="toggleItemCheck" data-index="{{index}}" color="#ff4757" />
        </view>

        <!-- 2. 商品图文信息区（添加点击跳转） -->
        <view class="cart-item-info" bindtap="goToDetail" data-productid="{{item.productId}}">
          <image class="cart-item-img" src="{{item.productImage}}" mode="aspectFill"></image>
          <view class="cart-item-desc">
            <view class="cart-item-name">{{item.productTitle || item.producttitle}}</view>
            <view class="cart-item-spec">{{item.spec}}</view>
          </view>
        </view>

        <!-- 3. 价格+数量操作区 -->
        <view class="cart-item-operate">
          <view class="cart-item-price">¥{{item.currentPrice}}</view>
          <view class="cart-item-count">
            <view class="count-btn minus" bindtap="decreaseQuantity" data-index="{{index}}" data-item-id="{{item._id}}">-</view>
            <input class="count-input" type="number" value="{{item.quantity}}" bindinput="onQuantityInput" data-index="{{index}}" data-item-id="{{item._id}}" />
            <view class="count-btn plus" bindtap="increaseQuantity" data-index="{{index}}" data-item-id="{{item._id}}">+</view>
          </view>
        </view>

        <!-- 删除按钮 -->
        <view class="delete-btn" bindtap="deleteItem" data-index="{{index}}" data-item-id="{{item._id}}">
        </view>
      </view>
    </block>
  </view>

  <!-- 底部结算栏 -->
  <view class="cart-footer" wx:if="{{cartItems && cartItems.length > 0}}">
    <view class="select-all">
      <checkbox checked="{{isAllSelected}}" bindtap="toggleSelectAll"></checkbox>
      <text class="select-all-text">全选</text>
    </view>

    <view class="footer-content">
      <view class="price-info">
        <view class="total-price">
          <text class="total-label">合计：</text>
          <text class="total-value">
            <text class="price-symbol">¥</text>
            <text class="price-number">{{totalPrice}}</text>
          </text>
        </view>
        <view class="discount-info">
          <text class="discount-label">已优惠：</text>
          <text class="discount-value">-¥{{discountPrice}}</text>
          <text class="discount-detail" bindtap="showDiscountDetail">明细</text>
        </view>
      </view>

      <view class="action-buttons">
        <!-- 管理模式下显示“删除选中”按钮 -->
        <button 
          wx:if="{{isManageMode}}" 
          class="delete-selected-btn" 
          bindtap="deleteSelected"
          disabled="{{!hasSelectedItems}}"
        >
          删除选中({{selectedCount}})
        </button>
        <!-- 非管理模式下显示“结算”按钮 -->
        <button 
          wx:else 
          class="checkout-btn" 
          bindtap="navigateToConfirm" 
          disabled="{{!hasSelectedItems}}"
        >
          结算({{selectedCount}})
        </button>
      </view>
    </view>
  </view>



  <!-- 错误提示 -->
  <view class="error-message" wx:if="{{errorMessage}}">
    {{errorMessage}}
    <text class="retry-btn" bindtap="retryLoad">重试</text>
  </view>
</view>