# 登录功能调试指南

## 1. 微信 Open SDK 配置

### 1.1 小程序配置
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序管理后台 → 开发 → 开发设置
3. 确保以下配置正确：
   - **AppID** 和 **AppSecret** 已正确配置
   - **服务器域名** 已添加微信云函数相关域名
   - **消息推送** 配置（如需）

### 1.2 云开发配置
1. 进入微信开发者工具 → 云开发
2. 确保云环境已初始化并正常运行
3. 部署新创建的登录相关云函数：
   - `user-login`
   - `user-getInfo`

## 2. 一键登录权限开通

### 2.1 权限申请
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序管理后台 → 设置 → 接口设置
3. 找到以下接口并申请开通：
   - **获取手机号** (`wx.getPhoneNumber`)
   - **获取手机号掩码** (`wx.getPhoneMask`)
   - **本机号码一键登录** (`wx.weixinAppLogin`)

### 2.2 开通条件
- 小程序必须是企业主体
- 需提供相关资质证明
- 审核通过后即可使用

## 3. 调试环境限制

### 3.1 不支持的调试方式
- **移动应用助手调试**：`wx.getPhoneMask` 和 `wx.weixinAppLogin` 接口在移动应用助手中无法正常调试
- **模拟器调试**：部分真机特有的功能在模拟器中可能无法使用

### 3.2 推荐调试方式
- **真机调试**：使用真实手机进行调试
- **预览模式**：通过微信开发者工具生成预览码，使用手机扫码预览

## 4. 调试步骤

### 4.1 基础调试
1. 确保云函数已正确部署
2. 启动微信开发者工具
3. 点击「预览」按钮生成预览码
4. 使用手机扫码进入小程序

### 4.2 登录流程调试
1. **浏览测试**：打开小程序，浏览各个页面，确认无需登录即可访问
2. **登录触发测试**：点击「加入购物车」或「立即购买」按钮
   - 未登录时应弹出「未注册」弹窗
   - 点击「确定」后应跳转至登录页
3. **登录页测试**：
   - 测试头像选择功能
   - 测试昵称输入功能
   - 测试手机号掩码获取
   - 测试本机号码一键登录
   - 测试其他信息填写（性别、生日、地区）
   - 测试「保存并登录」功能

### 4.3 登录态维护测试
1. 登录成功后，关闭小程序
2. 重新打开小程序，确认登录态已保持
3. 测试退出登录功能（如需）

## 5. 常见问题及解决方案

### 5.1 云函数调用失败
- **问题**：云函数调用返回错误
- **解决方案**：
  1. 检查云函数是否已正确部署
  2. 检查云函数代码是否有语法错误
  3. 检查云环境配置是否正确

### 5.2 手机号相关接口失败
- **问题**：`wx.getPhoneMask` 或 `wx.weixinAppLogin` 调用失败
- **解决方案**：
  1. 确认相关权限已开通
  2. 确认使用的是真机调试
  3. 检查小程序主体是否为企业

### 5.3 登录态丢失
- **问题**：登录成功后，关闭小程序重新打开，登录态丢失
- **解决方案**：
  1. 检查 `auth.js` 中的 `saveLoginStatus` 方法是否正确
  2. 检查本地存储是否正常
  3. 检查全局变量是否正确设置

### 5.4 数据库操作失败
- **问题**：用户信息无法保存到数据库
- **解决方案**：
  1. 检查数据库集合是否存在
  2. 检查数据库权限设置是否正确
  3. 检查云函数中的数据库操作代码是否正确

## 6. 日志调试

### 6.1 前端日志
在微信开发者工具的控制台中查看前端日志，主要关注：
- 登录相关的 API 调用结果
- 云函数调用结果
- 错误信息

### 6.2 云函数日志
在微信开发者工具的云开发控制台中查看云函数日志，主要关注：
- 云函数调用参数
- 云函数执行结果
- 错误信息

## 7. 注意事项

1. **安全性**：确保用户敏感信息（如手机号）的传输和存储安全
2. **兼容性**：确保代码兼容不同版本的微信客户端
3. **用户体验**：确保登录流程流畅，错误提示友好
4. **性能**：优化登录流程，减少不必要的网络请求

## 8. 测试账号

如需测试，可使用以下测试账号：
- **微信账号**：请使用真实微信账号
- **手机号**：请使用真实手机号（用于测试一键登录功能）

---

**注**：本调试指南仅适用于本项目的登录功能调试，如有其他问题请参考微信官方文档或联系技术支持。