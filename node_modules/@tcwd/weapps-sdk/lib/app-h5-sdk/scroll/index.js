import { getTimingFunc, easeInOut } from '../utils/index';
/**
 * @typedef {object} PageScrollToParam pageScrollTo参数
 * @property {number} scrollTop 滚动到页面的目标位置，单位 px
 * @property {number} [duration=300] 滚动动画的时长，单位 ms
 * @property {function} [success] 接口调用成功的回调函数
 * @property {function} [fail] 接口调用失败的回调函数
 * @property {function} [complete] 接口调用结束的回调函数（调用成功、失败都会执行）
 */
var scrollFunc;
var timer;
var FRAME_DURATION = 17;
/**
 * 将页面滚动到目标位置
 * @param {PageScrollToParam} object 参数
 */
export var pageScrollTo = function (_a) {
    var scrollTop = _a.scrollTop, selector = _a.selector, _b = _a.duration, duration = _b === void 0 ? 300 : _b, success = _a.success, fail = _a.fail, complete = _a.complete;
    return new Promise(function (resolve, reject) {
        try {
            if (scrollTop === undefined) {
                throw Error('"scrollTop" is required');
            }
            var el_1 = selector ? document.querySelector(selector) || window : window;
            if (!scrollFunc) {
                if (el_1 === window) {
                    scrollFunc = function (pos) {
                        if (pos === undefined) {
                            return window.pageYOffset;
                        }
                        else {
                            window.scrollTo(0, pos);
                        }
                    };
                }
                else {
                    scrollFunc = function (pos) {
                        if (pos === undefined) {
                            return el_1.scrollTop;
                        }
                        else {
                            el_1.scrollTop = pos;
                        }
                    };
                }
            }
            var from_1 = scrollFunc();
            var to = scrollTop;
            var delta_1 = to - from_1;
            var frameCnt_1 = duration / FRAME_DURATION;
            var easeFunc_1 = getTimingFunc(easeInOut, frameCnt_1);
            var scroll_1 = function (frame) {
                if (frame === void 0) { frame = 0; }
                var dest = from_1 + delta_1 * easeFunc_1(frame);
                scrollFunc(dest);
                if (frame < frameCnt_1) {
                    timer && clearTimeout(timer);
                    timer = setTimeout(function () {
                        scroll_1(frame + 1);
                    }, FRAME_DURATION);
                }
                else {
                    var res = {
                        errMsg: 'pageScrollTo:ok'
                    };
                    success && success(res);
                    complete && complete(res);
                    resolve(res);
                }
            };
            scroll_1();
        }
        catch (e) {
            var res = {
                errMsg: "pageScrollTo:fail " + e.message
            };
            fail && fail(res);
            complete && complete(res);
            reject(res);
        }
    });
};
