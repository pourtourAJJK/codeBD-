import { __assign } from "tslib";
var id = 0;
var ComCallbackName = 'jssdk__weappsNative__';
var __weappsNative = window.__weappsNative;
var WeappsOnEvents = {};
var NativeSdks = [
    /**
     * 认证登陆
     */
    'weiXinLogin',
    /*
     * 认证登陆
     */
    'faceVeriftLogin',
    /**
     * 跳到签名页
     */
    'startSignPage',
    /**
     * 强制竖屏 "orientation":"vertical | horizontal"
     */
    'setScreenOrientation'
];
function injection(keys, obj) {
    keys.forEach(function (element) {
        if (element.includes('Sync')) {
            obj[element] = function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                try {
                    console.log(element, args, '进入函数调用Sync');
                    var sdkJson = {
                        data: args,
                    };
                    console.log('开始执行__weappsNative.Sync...', element, sdkJson, __weappsNative[element]);
                    console.log("\n                __weappsNative[" + element + "](" + JSON.stringify(sdkJson) + ")\n            ");
                    var result = __weappsNative && __weappsNative[element](JSON.stringify(sdkJson));
                    return result ? JSON.parse(result) : null;
                }
                catch (e) {
                    console.error(e);
                }
            };
        }
        else if (element.startsWith('on')) {
            var eventKey_1 = element.substr(2);
            if (!WeappsOnEvents[eventKey_1]) {
                WeappsOnEvents[eventKey_1] = [];
            }
            obj[element] = function (callback) {
                console.log(element, '进入函数调用 on');
                if (typeof callback !== 'function') {
                    console.error(callback, 'is not function');
                    return;
                }
                WeappsOnEvents[eventKey_1].push(callback);
                // 只需要注册一次
                if (WeappsOnEvents[eventKey_1].length === 1) {
                    var callbackName_1 = ComCallbackName + element + id++;
                    WeappsOnEvents[eventKey_1].callbackName = callbackName_1;
                    window[callbackName_1] = function (err, args) {
                        try {
                            console.log(err, args, callbackName_1, 'jsbridge 执行了');
                            WeappsOnEvents[eventKey_1].forEach(function (cb) {
                                typeof cb === 'function' && cb(args ? JSON.parse(args) : null);
                            });
                        }
                        catch (e) {
                            console.log(e.stack, element + " callback \u8C03\u7528\u51FA\u9519");
                        }
                    };
                    var sdkJson = {
                        callback: callbackName_1,
                    };
                    console.log('开始执行__weappsNative.on...', element, sdkJson, __weappsNative[element]);
                    console.log("\n              __weappsNative[" + element + "](" + JSON.stringify(sdkJson) + ")\n          ");
                    __weappsNative && __weappsNative[element](JSON.stringify(sdkJson));
                }
            };
        }
        else if (element.startsWith('off')) {
            var eventKey_2 = element.substr(3);
            obj[element] = function (callback) {
                console.log(element, '进入函数调用 off');
                if (typeof callback !== 'function') {
                    console.error(callback, 'is not function');
                    return;
                }
                var callbackName = WeappsOnEvents[eventKey_2].callbackName;
                if (!callbackName) {
                    return;
                }
                console.log(element, "WeappsOnEvents[" + eventKey_2 + "]  callbackName:", callbackName);
                var funcIndex = WeappsOnEvents[eventKey_2].findIndex(function (cb) { return cb === callback; });
                if (funcIndex > -1) {
                    WeappsOnEvents[eventKey_2].splice(funcIndex, 1);
                }
                // 只需要注册一次
                if (WeappsOnEvents[eventKey_2].length === 0) {
                    var sdkJson = {
                        callback: callbackName,
                    };
                    console.log('开始执行__weappsNative.off...', element, sdkJson, __weappsNative[element]);
                    console.log("\n              __weappsNative[" + element + "](" + JSON.stringify(sdkJson) + ")\n          ");
                    __weappsNative && __weappsNative[element](JSON.stringify(sdkJson));
                }
            };
        }
        else {
            obj[element] = function (json) {
                if (json === void 0) { json = {}; }
                return new Promise(function (res, rej) {
                    console.log(element, json, '进入函数调用 返回promise');
                    var callbackName = ComCallbackName + element + id++;
                    window[callbackName] = function (err, args) {
                        try {
                            console.log(callbackName, err, args, 'jsbridge 执行了');
                            if (err !== 'null') {
                                var _err = err ? JSON.parse(err) : null;
                                typeof json.fail === 'function' && json.fail(_err);
                                rej(_err);
                                return;
                            }
                            var _args = args ? JSON.parse(args) : null;
                            typeof json.success === 'function' && json.success(_args);
                            res(_args);
                        }
                        catch (e) {
                            console.log(e.stack, element + " \u8C03\u7528\u51FA\u9519");
                            typeof json.fail === 'function' && json.fail(e);
                            rej(e);
                        }
                        finally {
                            typeof json.complete === 'function' && json.complete();
                            delete window[callbackName];
                        }
                    };
                    var data = __assign({}, json);
                    delete data.success;
                    delete data.fail;
                    delete data.complete;
                    var sdkJson = {
                        data: data,
                        callback: callbackName,
                    };
                    console.log('开始执行__weappsNative...', element, sdkJson, __weappsNative[element]);
                    console.log("\n              __weappsNative[" + element + "](" + JSON.stringify(sdkJson) + ")\n            ");
                    return __weappsNative && __weappsNative[element](JSON.stringify(sdkJson));
                });
            };
        }
    });
}
function makeOnlyNativeJsSDK() {
    var app = {};
    if (process.env.isApp) {
        if (!__weappsNative) {
            console.warn('window.__weappsNative 不存在，请求确认jssdk是否成功注入！');
            return app;
        }
        injection(NativeSdks, app);
    }
    return app;
}
export default makeOnlyNativeJsSDK();
export function getCommonJSSDKS() {
    var sdks = {};
    if (process.env.isApp) {
        if (!window.__weappsNative) {
            console.warn('window.__weappsNative 不存在，请求确认jssdk是否成功注入！');
            return sdks;
        }
        var apis = Object.keys(__weappsNative).filter(function (key) { return !NativeSdks.includes(key); });
        injection(apis, sdks);
    }
    return sdks;
}
