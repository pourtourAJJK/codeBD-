"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.openURIWithCallback = void 0;
var events_1 = require("@cloudbase/utilities/dist/cjs/libs/events");
var util_1 = require("@cloudbase/utilities/dist/cjs/libs/util");
var debounce = function (func, delay) {
    var timeoutId;
    return function () {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        clearTimeout(timeoutId);
        timeoutId = setTimeout(function () { return func.apply(null, args); }, delay);
    };
};
var eventBus = new events_1.CloudbaseEventEmitter();
var CAPTCHA_EVENT = {
    CAPTCHA_DATA_CHANGE: 'captchaDataChange',
    RESOLVE_CAPTCHA_DATA: 'resolveCaptchaData',
};
var CAPTCHA_STYLES = {
    overlay: 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999',
    modal: 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:320px;padding:20px;background:#fff;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.2);z-index:1000',
    prompt: 'margin-bottom:15px',
    captchaWrap: 'display:flex;align-items:center;justify-content:space-between;margin-bottom:15px',
    captchaImg: 'width:100%;height:auto;border:1px solid #eee',
    refreshBtn: 'padding:10px 8px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;flex:1;white-space:nowrap;margin-left:10px',
    input: 'width:100%;padding:14px 16px;margin-bottom:15px;box-sizing:border-box;border:2px solid #e8ecf4;border-radius:10px;font-size:15px',
    confirmBtn: 'width:100%;padding:10px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer',
    loading: 'background:#6c757d;cursor:not-allowed',
};
var genCaptchaDom = function (_a) {
    var oauthInstance = _a.oauthInstance, captchaState = _a.captchaState;
    var CAPTCHA_IMG_ID = 'captcha-image';
    var refreshCaptcha = function () { return __awaiter(void 0, void 0, void 0, function () {
        var result, error_1;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    return [4, oauthInstance.createCaptchaData({ state: captchaState.state })];
                case 1:
                    result = _a.sent();
                    captchaState = __assign(__assign({}, captchaState), { captchaData: result.data, token: result.token });
                    document.getElementById(CAPTCHA_IMG_ID).src = result.data;
                    return [3, 3];
                case 2:
                    error_1 = _a.sent();
                    console.error('刷新图形验证码失败', error_1);
                    return [3, 3];
                case 3: return [2];
            }
        });
    }); };
    var createElement = function (tag, styles, text) {
        var el = document.createElement(tag);
        if (styles)
            el.style.cssText = styles;
        if (text)
            el.textContent = text;
        return el;
    };
    var overlay = createElement('div', CAPTCHA_STYLES.overlay);
    var modal = createElement('div', CAPTCHA_STYLES.modal);
    modal.appendChild(createElement('p', CAPTCHA_STYLES.prompt, '请输入你看到的字符：'));
    var captchaWrap = createElement('div', CAPTCHA_STYLES.captchaWrap);
    var captchaImg = createElement('img', CAPTCHA_STYLES.captchaImg);
    captchaImg.id = CAPTCHA_IMG_ID;
    captchaImg.src = captchaState.captchaData;
    captchaWrap.appendChild(captchaImg);
    var refreshBtn = createElement('button', CAPTCHA_STYLES.refreshBtn, '刷新');
    refreshBtn.onclick = debounce(function () { return __awaiter(void 0, void 0, void 0, function () {
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    refreshBtn.textContent = '加载中...';
                    refreshBtn.disabled = true;
                    refreshBtn.style.cssText = "".concat(CAPTCHA_STYLES.refreshBtn, ";").concat(CAPTCHA_STYLES.loading);
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, , 3, 4]);
                    return [4, refreshCaptcha()];
                case 2:
                    _a.sent();
                    return [3, 4];
                case 3:
                    refreshBtn.textContent = '刷新';
                    refreshBtn.disabled = false;
                    refreshBtn.style.cssText = CAPTCHA_STYLES.refreshBtn;
                    return [7];
                case 4: return [2];
            }
        });
    }); }, 500);
    captchaWrap.appendChild(refreshBtn);
    modal.appendChild(captchaWrap);
    var input = createElement('input', CAPTCHA_STYLES.input);
    input.type = 'text';
    input.placeholder = '输入字符';
    input.maxLength = 4;
    modal.appendChild(input);
    var errorMsg = createElement('div', 'color:#dc3545;font-size:12px;margin-bottom:10px;display:none;padding:8px;background:#f8d7da;border:1px solid #f5c6cb;border-radius:4px');
    modal.appendChild(errorMsg);
    var showError = function (message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
    };
    var confirmBtn = createElement('button', CAPTCHA_STYLES.confirmBtn, '确定');
    confirmBtn.onclick = debounce(function () { return __awaiter(void 0, void 0, void 0, function () {
        var inputValue, verifyResult, error_2, errorMessage;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    inputValue = input.value.trim();
                    if (!inputValue) {
                        showError('请输入字符');
                        return [2];
                    }
                    errorMsg.style.display = 'none';
                    confirmBtn.textContent = '验证中...';
                    confirmBtn.disabled = true;
                    confirmBtn.style.cssText = "".concat(CAPTCHA_STYLES.confirmBtn, ";").concat(CAPTCHA_STYLES.loading);
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, 5, 6]);
                    return [4, oauthInstance.verifyCaptchaData({
                            token: captchaState.token,
                            key: inputValue,
                        })];
                case 2:
                    verifyResult = _a.sent();
                    eventBus.fire(CAPTCHA_EVENT.RESOLVE_CAPTCHA_DATA, verifyResult);
                    console.log('图形验证码校验成功');
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                    return [3, 6];
                case 3:
                    error_2 = _a.sent();
                    console.error('图形验证码校验失败', error_2);
                    errorMessage = error_2.error_description || '图形验证码校验失败';
                    showError(errorMessage);
                    input.value = '';
                    input.focus();
                    return [4, refreshCaptcha()];
                case 4:
                    _a.sent();
                    return [3, 6];
                case 5:
                    confirmBtn.textContent = '确定';
                    confirmBtn.disabled = false;
                    confirmBtn.style.cssText = CAPTCHA_STYLES.confirmBtn;
                    return [7];
                case 6: return [2];
            }
        });
    }); }, 500);
    modal.appendChild(confirmBtn);
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
};
var openURIWithCallback = function (url, oauthInstance) { return __awaiter(void 0, void 0, void 0, function () {
    var _a, captchaData, state, token;
    return __generator(this, function (_b) {
        _a = (0, util_1.parseCaptcha)(url), captchaData = _a.captchaData, state = _a.state, token = _a.token;
        genCaptchaDom({ oauthInstance: oauthInstance, captchaState: { captchaData: captchaData, state: state, token: token } });
        return [2, new Promise(function (resolve) {
                console.log('等待图形验证码校验结果...');
                eventBus.on(CAPTCHA_EVENT.RESOLVE_CAPTCHA_DATA, function (res) {
                    resolve(res === null || res === void 0 ? void 0 : res.data);
                });
            })];
    });
}); };
exports.openURIWithCallback = openURIWithCallback;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwdGNoYS1kb20uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY2FwdGNoYS9jYXB0Y2hhLWRvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLG9FQUFpRjtBQUNqRixnRUFBc0U7QUFJdEUsSUFBTSxRQUFRLEdBQUcsVUFBQyxJQUFjLEVBQUUsS0FBYTtJQUM3QyxJQUFJLFNBQXlCLENBQUE7SUFDN0IsT0FBTztRQUFDLGNBQWM7YUFBZCxVQUFjLEVBQWQscUJBQWMsRUFBZCxJQUFjO1lBQWQseUJBQWM7O1FBQ3BCLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUN2QixTQUFTLEdBQUcsVUFBVSxDQUFDLGNBQU0sT0FBQSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBdEIsQ0FBc0IsRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUM3RCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUE7QUFFRCxJQUFNLFFBQVEsR0FBRyxJQUFJLDhCQUFxQixFQUFFLENBQUE7QUFFNUMsSUFBTSxhQUFhLEdBQUc7SUFDcEIsbUJBQW1CLEVBQUUsbUJBQW1CO0lBQ3hDLG9CQUFvQixFQUFFLG9CQUFvQjtDQUMzQyxDQUFBO0FBR0QsSUFBTSxjQUFjLEdBQUc7SUFDckIsT0FBTyxFQUFFLDJGQUEyRjtJQUNwRyxLQUFLLEVBQ0gsK0tBQStLO0lBQ2pMLE1BQU0sRUFBRSxvQkFBb0I7SUFDNUIsV0FBVyxFQUFFLGtGQUFrRjtJQUMvRixVQUFVLEVBQUUsOENBQThDO0lBQzFELFVBQVUsRUFDUix3SUFBd0k7SUFDMUksS0FBSyxFQUNILGtJQUFrSTtJQUNwSSxVQUFVLEVBQUUsb0dBQW9HO0lBQ2hILE9BQU8sRUFBRSx1Q0FBdUM7Q0FDakQsQ0FBQTtBQU1ELElBQU0sYUFBYSxHQUFHLFVBQUMsRUFBK0I7UUFBN0IsYUFB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LENBQUMsRUFBL0MsV0FBVyxpQkFBQSxFQUFFLEtBQUssV0FBQSxFQUFFLEtBQUssV0FBQSxDQUFzQjtRQUV2RCxhQUFhLENBQUMsRUFBRSxhQUFhLGVBQUEsRUFBRSxZQUFZLEVBQUUsRUFBRSxXQUFXLGFBQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUc3RSxXQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTztnQkFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO2dCQUM3QixRQUFRLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsRUFBRSxVQUFDLEdBQUc7b0JBRWxELE9BQU8sQ0FBQyxHQUFHLGFBQUgsR0FBRyx1QkFBSCxHQUFHLENBQUUsSUFBSSxDQUFDLENBQUE7Z0JBQ3BCLENBQUMsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxDQUFDLEVBQUE7O0tBQ0gsQ0FBQTtBQWRZLFFBQUEsbUJBQW1CLHVCQWMvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhcHRjaGFUb2tlbiB9IGZyb20gJ0BjbG91ZGJhc2UvYWRhcHRlci1pbnRlcmZhY2UnXG5pbXBvcnQgeyBDbG91ZGJhc2VFdmVudEVtaXR0ZXIgfSBmcm9tICdAY2xvdWRiYXNlL3V0aWxpdGllcy9kaXN0L2Nqcy9saWJzL2V2ZW50cydcbmltcG9ydCB7IHBhcnNlQ2FwdGNoYSB9IGZyb20gJ0BjbG91ZGJhc2UvdXRpbGl0aWVzL2Rpc3QvY2pzL2xpYnMvdXRpbCdcbmltcG9ydCB7IEF1dGggfSBmcm9tICcuLi9hdXRoL2FwaXMnXG5cbi8vIOmYsuaKluWHveaVsOWunueOsFxuY29uc3QgZGVib3VuY2UgPSAoZnVuYzogRnVuY3Rpb24sIGRlbGF5OiBudW1iZXIpID0+IHtcbiAgbGV0IHRpbWVvdXRJZDogTm9kZUpTLlRpbWVvdXRcbiAgcmV0dXJuICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpXG4gICAgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpLCBkZWxheSlcbiAgfVxufVxuXG5jb25zdCBldmVudEJ1cyA9IG5ldyBDbG91ZGJhc2VFdmVudEVtaXR0ZXIoKVxuXG5jb25zdCBDQVBUQ0hBX0VWRU5UID0ge1xuICBDQVBUQ0hBX0RBVEFfQ0hBTkdFOiAnY2FwdGNoYURhdGFDaGFuZ2UnLFxuICBSRVNPTFZFX0NBUFRDSEFfREFUQTogJ3Jlc29sdmVDYXB0Y2hhRGF0YScsXG59XG5cbi8vIOWbvuW9oumqjOivgeeggeW8ueeql+agt+W8j+exu1xuY29uc3QgQ0FQVENIQV9TVFlMRVMgPSB7XG4gIG92ZXJsYXk6ICdwb3NpdGlvbjpmaXhlZDt0b3A6MDtsZWZ0OjA7d2lkdGg6MTAwJTtoZWlnaHQ6MTAwJTtiYWNrZ3JvdW5kOnJnYmEoMCwwLDAsMC41KTt6LWluZGV4Ojk5OScsXG4gIG1vZGFsOlxuICAgICdwb3NpdGlvbjphYnNvbHV0ZTt0b3A6NTAlO2xlZnQ6NTAlO3RyYW5zZm9ybTp0cmFuc2xhdGUoLTUwJSwtNTAlKTt3aWR0aDozMjBweDtwYWRkaW5nOjIwcHg7YmFja2dyb3VuZDojZmZmO2JvcmRlci1yYWRpdXM6OHB4O2JveC1zaGFkb3c6MCAwIDEwcHggcmdiYSgwLDAsMCwwLjIpO3otaW5kZXg6MTAwMCcsXG4gIHByb21wdDogJ21hcmdpbi1ib3R0b206MTVweCcsXG4gIGNhcHRjaGFXcmFwOiAnZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjttYXJnaW4tYm90dG9tOjE1cHgnLFxuICBjYXB0Y2hhSW1nOiAnd2lkdGg6MTAwJTtoZWlnaHQ6YXV0bztib3JkZXI6MXB4IHNvbGlkICNlZWUnLFxuICByZWZyZXNoQnRuOlxuICAgICdwYWRkaW5nOjEwcHggOHB4O2JhY2tncm91bmQ6IzAwN2JmZjtjb2xvcjojZmZmO2JvcmRlcjpub25lO2JvcmRlci1yYWRpdXM6NHB4O2N1cnNvcjpwb2ludGVyO2ZsZXg6MTt3aGl0ZS1zcGFjZTpub3dyYXA7bWFyZ2luLWxlZnQ6MTBweCcsXG4gIGlucHV0OlxuICAgICd3aWR0aDoxMDAlO3BhZGRpbmc6MTRweCAxNnB4O21hcmdpbi1ib3R0b206MTVweDtib3gtc2l6aW5nOmJvcmRlci1ib3g7Ym9yZGVyOjJweCBzb2xpZCAjZThlY2Y0O2JvcmRlci1yYWRpdXM6MTBweDtmb250LXNpemU6MTVweCcsXG4gIGNvbmZpcm1CdG46ICd3aWR0aDoxMDAlO3BhZGRpbmc6MTBweDtiYWNrZ3JvdW5kOiMwMDdiZmY7Y29sb3I6I2ZmZjtib3JkZXI6bm9uZTtib3JkZXItcmFkaXVzOjRweDtjdXJzb3I6cG9pbnRlcicsXG4gIGxvYWRpbmc6ICdiYWNrZ3JvdW5kOiM2Yzc1N2Q7Y3Vyc29yOm5vdC1hbGxvd2VkJyxcbn1cblxuLyoqXG4gKiDmmL7npLrlm77lvaLlm77lvaLpqozor4HnoIFcbiAqIEBwYXJhbSBwYXJhbTBcbiAqL1xuY29uc3QgZ2VuQ2FwdGNoYURvbSA9ICh7IG9hdXRoSW5zdGFuY2UsIGNhcHRjaGFTdGF0ZSB9KSA9PiB7XG4gIGNvbnN0IENBUFRDSEFfSU1HX0lEID0gJ2NhcHRjaGEtaW1hZ2UnXG5cbiAgLy8g5Yi35paw5Zu+5b2i6aqM6K+B56CB5Ye95pWwXG4gIGNvbnN0IHJlZnJlc2hDYXB0Y2hhID0gYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBvYXV0aEluc3RhbmNlLmNyZWF0ZUNhcHRjaGFEYXRhKHsgc3RhdGU6IGNhcHRjaGFTdGF0ZS5zdGF0ZSB9KVxuICAgICAgY2FwdGNoYVN0YXRlID0geyAuLi5jYXB0Y2hhU3RhdGUsIGNhcHRjaGFEYXRhOiByZXN1bHQuZGF0YSwgdG9rZW46IHJlc3VsdC50b2tlbiB9XG4gICAgICA7KGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKENBUFRDSEFfSU1HX0lEKSBhcyBIVE1MSW1hZ2VFbGVtZW50KS5zcmMgPSByZXN1bHQuZGF0YVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfliLfmlrDlm77lvaLpqozor4HnoIHlpLHotKUnLCBlcnJvcilcbiAgICB9XG4gIH1cblxuICAvLyDliJvlu7rlhYPntKDlubborr7nva7moLflvI9cbiAgY29uc3QgY3JlYXRlRWxlbWVudCA9ICh0YWc6IHN0cmluZywgc3R5bGVzPzogc3RyaW5nLCB0ZXh0Pzogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZylcbiAgICBpZiAoc3R5bGVzKSBlbC5zdHlsZS5jc3NUZXh0ID0gc3R5bGVzXG4gICAgaWYgKHRleHQpIGVsLnRleHRDb250ZW50ID0gdGV4dFxuICAgIHJldHVybiBlbFxuICB9XG5cbiAgLy8g5Yib5bu66YGu572p5bGC5ZKM5by556qXXG4gIGNvbnN0IG92ZXJsYXkgPSBjcmVhdGVFbGVtZW50KCdkaXYnLCBDQVBUQ0hBX1NUWUxFUy5vdmVybGF5KVxuICBjb25zdCBtb2RhbCA9IGNyZWF0ZUVsZW1lbnQoJ2RpdicsIENBUFRDSEFfU1RZTEVTLm1vZGFsKVxuXG4gIC8vIOa3u+WKoOaPkOekuuaWh+Wtl1xuICBtb2RhbC5hcHBlbmRDaGlsZChjcmVhdGVFbGVtZW50KCdwJywgQ0FQVENIQV9TVFlMRVMucHJvbXB0LCAn6K+36L6T5YWl5L2g55yL5Yiw55qE5a2X56ym77yaJykpXG5cbiAgLy8g5Zu+5b2i6aqM6K+B56CB5Yy65Z+fXG4gIGNvbnN0IGNhcHRjaGFXcmFwID0gY3JlYXRlRWxlbWVudCgnZGl2JywgQ0FQVENIQV9TVFlMRVMuY2FwdGNoYVdyYXApXG4gIGNvbnN0IGNhcHRjaGFJbWcgPSBjcmVhdGVFbGVtZW50KCdpbWcnLCBDQVBUQ0hBX1NUWUxFUy5jYXB0Y2hhSW1nKSBhcyBIVE1MSW1hZ2VFbGVtZW50XG4gIGNhcHRjaGFJbWcuaWQgPSBDQVBUQ0hBX0lNR19JRFxuICBjYXB0Y2hhSW1nLnNyYyA9IGNhcHRjaGFTdGF0ZS5jYXB0Y2hhRGF0YVxuICBjYXB0Y2hhV3JhcC5hcHBlbmRDaGlsZChjYXB0Y2hhSW1nKVxuXG4gIC8vIOWIt+aWsOaMiemSrlxuICBjb25zdCByZWZyZXNoQnRuID0gY3JlYXRlRWxlbWVudCgnYnV0dG9uJywgQ0FQVENIQV9TVFlMRVMucmVmcmVzaEJ0biwgJ+WIt+aWsCcpIGFzIEhUTUxCdXR0b25FbGVtZW50XG4gIHJlZnJlc2hCdG4ub25jbGljayA9IGRlYm91bmNlKGFzeW5jICgpID0+IHtcbiAgICByZWZyZXNoQnRuLnRleHRDb250ZW50ID0gJ+WKoOi9veS4rS4uLidcbiAgICByZWZyZXNoQnRuLmRpc2FibGVkID0gdHJ1ZVxuICAgIHJlZnJlc2hCdG4uc3R5bGUuY3NzVGV4dCA9IGAke0NBUFRDSEFfU1RZTEVTLnJlZnJlc2hCdG59OyR7Q0FQVENIQV9TVFlMRVMubG9hZGluZ31gXG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmVmcmVzaENhcHRjaGEoKVxuICAgIH0gZmluYWxseSB7XG4gICAgICByZWZyZXNoQnRuLnRleHRDb250ZW50ID0gJ+WIt+aWsCdcbiAgICAgIHJlZnJlc2hCdG4uZGlzYWJsZWQgPSBmYWxzZVxuICAgICAgcmVmcmVzaEJ0bi5zdHlsZS5jc3NUZXh0ID0gQ0FQVENIQV9TVFlMRVMucmVmcmVzaEJ0blxuICAgIH1cbiAgfSwgNTAwKVxuICBjYXB0Y2hhV3JhcC5hcHBlbmRDaGlsZChyZWZyZXNoQnRuKVxuICBtb2RhbC5hcHBlbmRDaGlsZChjYXB0Y2hhV3JhcClcblxuICAvLyDovpPlhaXmoYZcbiAgY29uc3QgaW5wdXQgPSBjcmVhdGVFbGVtZW50KCdpbnB1dCcsIENBUFRDSEFfU1RZTEVTLmlucHV0KSBhcyBIVE1MSW5wdXRFbGVtZW50XG4gIGlucHV0LnR5cGUgPSAndGV4dCdcbiAgaW5wdXQucGxhY2Vob2xkZXIgPSAn6L6T5YWl5a2X56ymJ1xuICBpbnB1dC5tYXhMZW5ndGggPSA0XG4gIG1vZGFsLmFwcGVuZENoaWxkKGlucHV0KVxuXG4gIC8vIOmUmeivr+aPkOekuuWFg+e0oFxuICBjb25zdCBlcnJvck1zZyA9IGNyZWF0ZUVsZW1lbnQoXG4gICAgJ2RpdicsXG4gICAgJ2NvbG9yOiNkYzM1NDU7Zm9udC1zaXplOjEycHg7bWFyZ2luLWJvdHRvbToxMHB4O2Rpc3BsYXk6bm9uZTtwYWRkaW5nOjhweDtiYWNrZ3JvdW5kOiNmOGQ3ZGE7Ym9yZGVyOjFweCBzb2xpZCAjZjVjNmNiO2JvcmRlci1yYWRpdXM6NHB4JyxcbiAgKVxuICBtb2RhbC5hcHBlbmRDaGlsZChlcnJvck1zZylcblxuICAvLyDmmL7npLrplJnor6/mj5DnpLpcbiAgY29uc3Qgc2hvd0Vycm9yID0gKG1lc3NhZ2U6IHN0cmluZykgPT4ge1xuICAgIGVycm9yTXNnLnRleHRDb250ZW50ID0gbWVzc2FnZVxuICAgIGVycm9yTXNnLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snXG4gIH1cblxuICAvLyDnoa7lrprmjInpkq5cbiAgY29uc3QgY29uZmlybUJ0biA9IGNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicsIENBUFRDSEFfU1RZTEVTLmNvbmZpcm1CdG4sICfnoa7lrponKSBhcyBIVE1MQnV0dG9uRWxlbWVudFxuICBjb25maXJtQnRuLm9uY2xpY2sgPSBkZWJvdW5jZShhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgaW5wdXRWYWx1ZSA9IGlucHV0LnZhbHVlLnRyaW0oKVxuICAgIGlmICghaW5wdXRWYWx1ZSkge1xuICAgICAgc2hvd0Vycm9yKCfor7fovpPlhaXlrZfnrKYnKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgLy8g6ZqQ6JeP5LmL5YmN55qE6ZSZ6K+v5o+Q56S6XG4gICAgZXJyb3JNc2cuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuXG4gICAgY29uZmlybUJ0bi50ZXh0Q29udGVudCA9ICfpqozor4HkuK0uLi4nXG4gICAgY29uZmlybUJ0bi5kaXNhYmxlZCA9IHRydWVcbiAgICBjb25maXJtQnRuLnN0eWxlLmNzc1RleHQgPSBgJHtDQVBUQ0hBX1NUWUxFUy5jb25maXJtQnRufTske0NBUFRDSEFfU1RZTEVTLmxvYWRpbmd9YFxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHZlcmlmeVJlc3VsdCA9IGF3YWl0IG9hdXRoSW5zdGFuY2UudmVyaWZ5Q2FwdGNoYURhdGEoe1xuICAgICAgICB0b2tlbjogY2FwdGNoYVN0YXRlLnRva2VuLFxuICAgICAgICBrZXk6IGlucHV0VmFsdWUsXG4gICAgICB9KVxuICAgICAgZXZlbnRCdXMuZmlyZShDQVBUQ0hBX0VWRU5ULlJFU09MVkVfQ0FQVENIQV9EQVRBLCB2ZXJpZnlSZXN1bHQpXG4gICAgICBjb25zb2xlLmxvZygn5Zu+5b2i6aqM6K+B56CB5qCh6aqM5oiQ5YqfJylcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQob3ZlcmxheSlcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobW9kYWwpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+WbvuW9oumqjOivgeeggeagoemqjOWksei0pScsIGVycm9yKVxuICAgICAgLy8g5qC55o2u6ZSZ6K+v57G75Z6L5pi+56S65LiN5ZCM55qE6ZSZ6K+v5o+Q56S6XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnJvci5lcnJvcl9kZXNjcmlwdGlvbiB8fCAn5Zu+5b2i6aqM6K+B56CB5qCh6aqM5aSx6LSlJ1xuICAgICAgc2hvd0Vycm9yKGVycm9yTWVzc2FnZSlcblxuICAgICAgLy8g5riF56m66L6T5YWl5qGG5bm25Yi35paw5Zu+5b2i6aqM6K+B56CBXG4gICAgICBpbnB1dC52YWx1ZSA9ICcnXG4gICAgICBpbnB1dC5mb2N1cygpXG4gICAgICBhd2FpdCByZWZyZXNoQ2FwdGNoYSgpXG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGNvbmZpcm1CdG4udGV4dENvbnRlbnQgPSAn56Gu5a6aJ1xuICAgICAgY29uZmlybUJ0bi5kaXNhYmxlZCA9IGZhbHNlXG4gICAgICBjb25maXJtQnRuLnN0eWxlLmNzc1RleHQgPSBDQVBUQ0hBX1NUWUxFUy5jb25maXJtQnRuXG4gICAgfVxuICB9LCA1MDApXG4gIG1vZGFsLmFwcGVuZENoaWxkKGNvbmZpcm1CdG4pXG5cbiAgLy8g5o+S5YWl6aG16Z2iXG4gIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQob3ZlcmxheSlcbiAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChtb2RhbClcbn1cblxuZXhwb3J0IGNvbnN0IG9wZW5VUklXaXRoQ2FsbGJhY2sgPSBhc3luYyAodXJsOiBzdHJpbmcsIG9hdXRoSW5zdGFuY2U/OiBBdXRoKTogUHJvbWlzZTxDYXB0Y2hhVG9rZW4+ID0+IHtcbiAgLy8g6Kej5p6QVVJM5Lit55qE5Zu+5b2i6aqM6K+B56CB5Y+C5pWwXG4gIGNvbnN0IHsgY2FwdGNoYURhdGEsIHN0YXRlLCB0b2tlbiB9ID0gcGFyc2VDYXB0Y2hhKHVybClcblxuICBnZW5DYXB0Y2hhRG9tKHsgb2F1dGhJbnN0YW5jZSwgY2FwdGNoYVN0YXRlOiB7IGNhcHRjaGFEYXRhLCBzdGF0ZSwgdG9rZW4gfSB9KVxuXG4gIC8vIOebkeWQrOWbvuW9oumqjOivgeeggeagoemqjOe7k+aenFxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBjb25zb2xlLmxvZygn562J5b6F5Zu+5b2i6aqM6K+B56CB5qCh6aqM57uT5p6cLi4uJylcbiAgICBldmVudEJ1cy5vbihDQVBUQ0hBX0VWRU5ULlJFU09MVkVfQ0FQVENIQV9EQVRBLCAocmVzKSA9PiB7XG4gICAgICAvLyBhdXRoLnZlcmlmeUNhcHRjaGFEYXRh55qE5qCh6aqM57uT5p6cXG4gICAgICByZXNvbHZlKHJlcz8uZGF0YSlcbiAgICB9KVxuICB9KVxufVxuIl19