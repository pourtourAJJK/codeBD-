import { Db } from '../src/index'

describe('数据库请求参数测试', function() {
  // 模拟请求类，用于捕获和验证请求参数
  class MockRequest {
    private config: any;
    
    constructor(config: any) {
      this.config = config;
    }

    async send(action: string, data: any) {
      // 验证 instance 和 database 参数是否正确传递
      if (this.config.instance) {
        expect(data).toHaveProperty('instance', this.config.instance);
      }
      if (this.config.database) {
        expect(data).toHaveProperty('database', this.config.database);
      }

      // 返回符合各操作期望的数据结构
      switch (action) {
        case 'database.queryDocument':
          return {
            data: {
              list: [
                { _id: 'doc1', name: '测试文档1', value: 100 },
                { _id: 'doc2', name: '测试文档2', value: 200 }
              ]
            },
            requestId: 'mock-request-id-123456',
            total: 2,
            limit: 100,
            offset: 0
          };
        default:
          return { data: { ok: 1 } };
      }
    }
  }

  // 测试配置
  const testConfig = { 
    env: 'test-env', 
    instance: 'test-instance', 
    database: 'test-database' 
  };

  // 在每个测试前配置
  beforeEach(function() {
    Db.reqClass = MockRequest;
  });

  it('集合查询操作应包含 instance 和 database 参数', async function() {
    const db = new Db(testConfig);
    const coll = db.collection('test-collection');
    await coll.where({}).get();
  });

  it('集合添加操作应包含 instance 和 database 参数', async function() {
    const db = new Db(testConfig);
    const coll = db.collection('test-collection');
    await coll.add({ name: '新文档', value: 300 });
  });

  it('文档更新操作应包含 instance 和 database 参数', async function() {
    const db = new Db(testConfig);
    const coll = db.collection('test-collection');
    const doc = coll.doc('doc1');
    await doc.update({ value: 150 });
  });

  it('聚合操作应包含 instance 和 database 参数', async function() {
    const db = new Db(testConfig);
    const coll = db.collection('test-collection');
    const aggregate = coll
      .aggregate()
      .match({ value: { $gt: 50 } })
      .group({ _id: null, total: { $sum: '$value' } });
    await aggregate.end();
  });

  it('创建集合操作应包含 instance 和 database 参数', async function() {
    const db = new Db(testConfig);
    await db.createCollection('new-collection');
  });

  it('应支持 const res = await db.collection(\'xxx\').get() 方式调用', async function() {
    const db = new Db(testConfig);
    const coll = db.collection('test-collection');
    
    // 测试直接调用 get() 而不传递 where 条件
    const res = await coll.get();
    console.log(res)
    
    // 验证返回结果的结构
    expect(res).toHaveProperty('data');
    expect(res).toHaveProperty('requestId');
    expect(res).toHaveProperty('total');
    expect(res).toHaveProperty('limit');
    expect(res).toHaveProperty('offset');
    
    // 验证返回的数据
    expect(Array.isArray(res.data)).toBe(true);
    expect(res.data.length).toBe(2);
    expect(res.data[0]).toHaveProperty('_id', 'doc1');
    expect(res.data[0]).toHaveProperty('name', '测试文档1');
    expect(res.data[1]).toHaveProperty('_id', 'doc2');
    expect(res.data[1]).toHaveProperty('name', '测试文档2');
  });
});
