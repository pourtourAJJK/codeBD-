"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useAuthAdapter = void 0;
var utilities_1 = require("./utilities");
var OauthClientStorageBase = (function () {
    function OauthClientStorageBase(config) {
        var _a, _b;
        try {
            this.localStorage = (config === null || config === void 0 ? void 0 : config.localStorage) || (((_b = (_a = config === null || config === void 0 ? void 0 : config.adapter) === null || _a === void 0 ? void 0 : _a.root) === null || _b === void 0 ? void 0 : _b.globalThis) || globalThis).localStorage;
        }
        catch (error) {
            this.localStorage = (config === null || config === void 0 ? void 0 : config.localStorage) || {};
        }
    }
    OauthClientStorageBase.prototype.getItem = function (key) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                return [2, this.localStorage.getItem(key)];
            });
        });
    };
    OauthClientStorageBase.prototype.removeItem = function (key) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                this.localStorage.removeItem(key);
                return [2];
            });
        });
    };
    OauthClientStorageBase.prototype.setItem = function (key, value) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                this.localStorage.setItem(key, value);
                return [2];
            });
        });
    };
    OauthClientStorageBase.prototype.getItemSync = function (key) {
        return this.localStorage.getItem(key);
    };
    OauthClientStorageBase.prototype.setItemSync = function (key, value) {
        this.localStorage.setItem(key, value);
    };
    OauthClientStorageBase.prototype.removeItemSync = function (key) {
        this.localStorage.removeItem(key);
    };
    return OauthClientStorageBase;
}());
var URL_REG = /^[^:]+:\/\/[^/]+(\/[^?#]+)/;
var dealAdapterRequestData = function (res, options) {
    var _a, _b, _c;
    var requestId = (_a = options === null || options === void 0 ? void 0 : options.headers) === null || _a === void 0 ? void 0 : _a['x-request-id'];
    if (!res) {
        res = {};
    }
    if ((res === null || res === void 0 ? void 0 : res.code) || ((_b = res === null || res === void 0 ? void 0 : res.data) === null || _b === void 0 ? void 0 : _b.error_code)) {
        res = {
            error: res.code || res.data.error,
            error_description: res.data.error_description || res.message || res.code || res.data.error_code,
            request_id: res.requestId,
            error_code: (_c = res.data) === null || _c === void 0 ? void 0 : _c.error_code,
        };
    }
    if (!(res === null || res === void 0 ? void 0 : res.request_id)) {
        res.request_id = res.request_id || requestId;
    }
    if (res === null || res === void 0 ? void 0 : res.error) {
        res.error_uri = getUrlPath(options === null || options === void 0 ? void 0 : options.url);
        return res;
    }
    return (res === null || res === void 0 ? void 0 : res.data) || {};
};
function generateOauthClientRequest(reqClass) {
    return function (url, options) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                return [2, new Promise(function (resolve, reject) {
                        var copyOptions = Object.assign({}, options);
                        if (copyOptions.body && typeof copyOptions.body !== 'string') {
                            copyOptions.body = JSON.stringify(copyOptions.body);
                        }
                        var task = wx.request({
                            url: url,
                            data: copyOptions.body,
                            timeout: reqClass._timeout,
                            method: copyOptions.method || 'GET',
                            header: copyOptions.headers,
                            success: function (res) {
                                res = dealAdapterRequestData(res, __assign(__assign({}, options), { url: url }));
                                if (res.error) {
                                    reject(res);
                                }
                                resolve(res);
                            },
                            fail: function (err) {
                                reject({
                                    error: 'unreachable',
                                    error_description: err.message,
                                });
                            },
                            complete: function (err) {
                                if (!err || !err.errMsg) {
                                    return;
                                }
                                if (!reqClass._timeout || reqClass._restrictedMethods.indexOf('request') === -1) {
                                    return;
                                }
                                var errMsg = err.errMsg;
                                if (errMsg === 'request:fail timeout') {
                                    console.warn(reqClass._timeoutMsg);
                                    try {
                                        task.abort();
                                    }
                                    catch (e) { }
                                }
                            },
                        });
                    })];
            });
        });
    };
}
function getUrlPath(url) {
    return URL_REG.test(url) ? RegExp.$1 : url;
}
var dealUserAdapter = function (config, adapter) {
    var data = __assign({}, config);
    try {
        if (!(config === null || config === void 0 ? void 0 : config.storage) && (adapter === null || adapter === void 0 ? void 0 : adapter.localStorage)) {
            data.storage = new OauthClientStorageBase({ localStorage: adapter.localStorage, adapter: adapter });
        }
        if (!config.captchaOptions && (adapter === null || adapter === void 0 ? void 0 : adapter.captchaOptions)) {
            data.captchaOptions = adapter.captchaOptions;
        }
        if (!config.baseRequest && !config.request && (adapter === null || adapter === void 0 ? void 0 : adapter.reqClass)) {
            var reqClassParams = {
                timeout: 10000,
                restrictedMethods: ['get', 'post', 'upload', 'download', 'request'],
            };
            var adapterReq_1 = new adapter.reqClass(reqClassParams);
            data.baseRequest = function (url, options) {
                var _a, _b, _c, _d, _e;
                return __awaiter(this, void 0, void 0, function () {
                    var res, requestType, func, error_1;
                    return __generator(this, function (_f) {
                        switch (_f.label) {
                            case 0:
                                res = {};
                                requestType = ((_a = options.method) === null || _a === void 0 ? void 0 : _a.toLocaleLowerCase()) || 'post';
                                func = (_c = (_b = adapterReq_1 === null || adapterReq_1 === void 0 ? void 0 : adapterReq_1[requestType]) === null || _b === void 0 ? void 0 : _b.bind) === null || _c === void 0 ? void 0 : _c.call(_b, adapterReq_1);
                                if (typeof func !== 'function') {
                                    throw new Error("invalid \u3010".concat(requestType, "\u3011 request method"));
                                }
                                _f.label = 1;
                            case 1:
                                _f.trys.push([1, 3, , 4]);
                                if ((!((_d = options.headers) === null || _d === void 0 ? void 0 : _d['content-type']) || ((_e = options.headers) === null || _e === void 0 ? void 0 : _e['content-type'].includes('application/json'))) && !['string', 'undefined'].includes(typeof options.body)) {
                                    options.data = options.data || options.body;
                                    options.body = JSON.stringify(options.body);
                                }
                                return [4, func(__assign({ url: url }, options))];
                            case 2:
                                res = _f.sent();
                                res = dealAdapterRequestData(res, __assign(__assign({}, options), { url: url }));
                                return [3, 4];
                            case 3:
                                error_1 = _f.sent();
                                res = __assign(__assign({}, error_1 === null || error_1 === void 0 ? void 0 : error_1.data), error_1);
                                throw res;
                            case 4:
                                if (res === null || res === void 0 ? void 0 : res.error) {
                                    throw res;
                                }
                                return [2, res];
                        }
                    });
                });
            };
        }
    }
    catch (e) {
        console.error('user adapter generate fail:', e);
    }
    return data;
};
var dealAuthAdapter = function (config, adapter) {
    var data = __assign({}, config);
    var authOptions = {};
    if (adapter === null || adapter === void 0 ? void 0 : adapter.captchaOptions) {
        data.captchaOptions = adapter.captchaOptions;
    }
    if (!utilities_1.adapterForWxMp.isMatch() || (config.storage && config.baseRequest))
        return data;
    try {
        var _a = utilities_1.adapterForWxMp.genAdapter({}), localStorage_1 = _a.localStorage, ReqClass = _a.reqClass;
        if (localStorage_1) {
            authOptions.storage = new OauthClientStorageBase({ localStorage: localStorage_1, adapter: adapter });
        }
        if (ReqClass) {
            var reqClass = new ReqClass({
                timeout: 10000,
                restrictedMethods: ['get', 'post', 'upload', 'download', 'request'],
            });
            authOptions.request = generateOauthClientRequest(reqClass);
        }
        if (data.captchaOptions) {
            authOptions.baseRequest = authOptions.request;
            authOptions.request = undefined;
        }
        return __assign(__assign({}, data), authOptions);
    }
    catch (e) {
        console.error('adapter generate fail:', e);
    }
    return data;
};
var useAuthAdapter = function (config) {
    if (config.adapter && config.adapter.type !== 'default') {
        return dealUserAdapter(config, config.adapter);
    }
    return dealAuthAdapter(config, config.adapter);
};
exports.useAuthAdapter = useAuthAdapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EseUNBQTRDO0FBSzVDO0lBRUUsZ0NBQVksTUFBbUY7O1FBQzdGLElBQUk7WUFDRixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUEsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLFlBQVksS0FBSSxDQUFDLENBQUEsTUFBQSxNQUFBLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxPQUFPLDBDQUFFLElBQUksMENBQUUsVUFBVSxLQUFJLFVBQVUsQ0FBQyxDQUFDLFlBQVksQ0FBQTtTQUMzRztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFBLE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxZQUFZLEtBQUksRUFBRSxDQUFBO1NBQy9DO0lBQ0gsQ0FBQztJQU1LLHdDQUFPLEdBQWIsVUFBYyxHQUFXOzs7Z0JBQ3ZCLFdBQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUE7OztLQUN0QztJQU9LLDJDQUFVLEdBQWhCLFVBQWlCLEdBQVc7OztnQkFDMUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUE7Ozs7S0FDbEM7SUFRSyx3Q0FBTyxHQUFiLFVBQWMsR0FBVyxFQUFFLEtBQWE7OztnQkFDdEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFBOzs7O0tBQ3RDO0lBRUQsNENBQVcsR0FBWCxVQUFZLEdBQVc7UUFDckIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRUQsNENB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QyxXQUFXLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQTtZQUM3QyxXQUFXLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQTtTQUNoQztRQUVELDZCQUFZLElBQUksR0FBSyxXQUFXLEVBQUU7S0FDbkM7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxDQUFDLENBQUE7S0FDM0M7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUMsQ0FBQTtBQUVNLElBQU0sY0FBYyxHQUFHLFVBQUMsTUFBbUI7SUFFaEQsSUFBSSxNQUFNLENBQUMsT0FBTyxJQUFLLE1BQU0sQ0FBQyxPQUFlLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRTtRQUNoRSxPQUFPLGVBQWUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0tBQy9DO0lBRUQsT0FBTyxlQUFlLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUNoRCxDQUFDLENBQUE7QUFQWSxRQUFBLGNBQWMsa0JBTzFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU0RLQWRhcHRlckludGVyZmFjZSB9IGZyb20gJ0BjbG91ZGJhc2UvYWRhcHRlci1pbnRlcmZhY2UnXG5pbXBvcnQgeyBhZGFwdGVyRm9yV3hNcCB9IGZyb20gJy4vdXRpbGl0aWVzJ1xuaW1wb3J0IHR5cGUgeyBBdXRoT3B0aW9ucyB9IGZyb20gJ0BjbG91ZGJhc2Uvb2F1dGgnXG5cbmRlY2xhcmUgY29uc3Qgd3g6IGFueVxuXG5jbGFzcyBPYXV0aENsaWVudFN0b3JhZ2VCYXNlIHtcbiAgcHVibGljIHJlYWRvbmx5IGxvY2FsU3RvcmFnZVxuICBjb25zdHJ1Y3Rvcihjb25maWc/OiB7IGxvY2FsU3RvcmFnZTogYW55IC8qIFN0b3JhZ2VJbnRlcmZhY2UgKi87IGFkYXB0ZXI6IFNES0FkYXB0ZXJJbnRlcmZhY2UgfSkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvY2FsU3RvcmFnZSA9IGNvbmZpZz8ubG9jYWxTdG9yYWdlIHx8IChjb25maWc/LmFkYXB0ZXI/LnJvb3Q/Lmdsb2JhbFRoaXMgfHwgZ2xvYmFsVGhpcykubG9jYWxTdG9yYWdlXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9jYWxTdG9yYWdlID0gY29uZmlnPy5sb2NhbFN0b3JhZ2UgfHwge31cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIEdldCBJdGVtXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXlcbiAgICogQHJldHVybiB7UHJvbWlzZTxzdHJpbmcgfCBudWxsPn1cbiAgICovXG4gIGFzeW5jIGdldEl0ZW0oa2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpXG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIEl0ZW0uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXlcbiAgICogQHJldHVybiB7UHJvbWlzZTx2b2lkPn1cbiAgICovXG4gIGFzeW5jIHJlbW92ZUl0ZW0oa2V5OiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgSXRlbS5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleVxuICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWVcbiAgICogQHJldHVybiB7UHJvbWlzZTx2b2lkPn1cbiAgICovXG4gIGFzeW5jIHNldEl0ZW0oa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgdmFsdWUpXG4gIH1cblxuICBnZXRJdGVtU3luYyhrZXk6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSlcbiAgfVxuXG4gIHNldEl0ZW1TeW5jKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbHVlKVxuICB9XG5cbiAgcmVtb3ZlSXRlbVN5bmMoa2V5OiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSlcbiAgfVxufVxuXG4vKipcbiAqIGNvcHkgdG8gZ2l0QGdpdC53b2EuY29tOlFCYXNlL2xjYXAvZGF0YXNvdXJjZS5naXQvcGFja2FnZXMvY2xvdWQtc2RrL2NvbW1vblxuICog5ZCM5q2l5L+u5pS5XG4gKi9cbmNvbnN0IFVSTF9SRUcgPSAvXlteOl0rOlxcL1xcL1teL10rKFxcL1tePyNdKykvXG5cbmNvbnN0IGRlYWxBZGFwdGVyUmVxdWVzdERhdGEgPSAocmVzLCBvcHRpb25zKSA9PiB7XG4gIGNvbnN0IHJlcXVlc3RJZCA9IG9wdGlvbnM/LmhlYWRlcnM/LlsneC1yZXF1ZXN0LWlkJ11cblxuICBpZiAoIXJlcykge1xuICAgIHJlcyA9IHt9XG4gIH1cblxuICBpZiAocmVzPy5jb2RlIHx8IHJlcz8uZGF0YT8uZXJyb3JfY29kZSkge1xuICAgIHJlcyA9IHtcbiAgICAgIGVycm9yOiByZXMuY29kZSB8fCByZXMuZGF0YS5lcnJvcixcbiAgICAgIGVycm9yX2Rlc2NyaXB0aW9uOiByZXMuZGF0YS5lcnJvcl9kZXNjcmlwdGlvbiB8fCByZXMubWVzc2FnZSB8fCByZXMuY29kZSB8fCByZXMuZGF0YS5lcnJvcl9jb2RlLFxuICAgICAgcmVxdWVzdF9pZDogcmVzLnJlcXVlc3RJZCxcbiAgICAgIGVycm9yX2NvZGU6IHJlcy5kYXRhPy5lcnJvcl9jb2RlLFxuICAgIH1cbiAgfVxuXG4gIGlmICghcmVzPy5yZXF1ZXN0X2lkKSB7XG4gICAgcmVzLnJlcXVlc3RfaWQgPSByZXMucmVxdWVzdF9pZCB8fCByZXF1ZXN0SWRcbiAgfVxuXG4gIGlmIChyZXM/LmVycm9yKSB7XG4gICAgcmVzLmVycm9yX3VyaSA9IGdldFVybFBhdGgob3B0aW9ucz8udXJsKVxuICAgIHJldHVybiByZXNcbiAgfVxuXG4gIHJldHVybiByZXM/LmRhdGEgfHwge31cbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVPYXV0aENsaWVudFJlcXVlc3QocmVxQ2xhc3MpIHtcbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uIChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBvcHRpb25zPzoge1xuICAgICAgYm9keT86IGFueSB8IG51bGxcbiAgICAgIGhlYWRlcnM/OiBhbnkgfCBudWxsXG4gICAgICBtZXRob2Q/OiBzdHJpbmdcbiAgICAgIFtrZXk6IHN0cmluZ106IGFueVxuICAgIH0sXG4gICkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBPYmplY3RzIG11c3QgYmUgY29waWVkIHRvIHByZXZlbnQgbW9kaWZpY2F0aW9uIG9mIGRhdGEgc3VjaCBhcyBib2R5LlxuICAgICAgY29uc3QgY29weU9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKVxuICAgICAgaWYgKGNvcHlPcHRpb25zLmJvZHkgJiYgdHlwZW9mIGNvcHlPcHRpb25zLmJvZHkgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvcHlPcHRpb25zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShjb3B5T3B0aW9ucy5ib2R5KVxuICAgICAgfVxuXG4gICAgICBjb25zdCB0YXNrID0gd3gucmVxdWVzdCh7XG4gICAgICAgIHVybCxcbiAgICAgICAgZGF0YTogY29weU9wdGlvbnMuYm9keSxcbiAgICAgICAgdGltZW91dDogcmVxQ2xhc3MuX3RpbWVvdXQsXG4gICAgICAgIG1ldGhvZDogY29weU9wdGlvbnMubWV0aG9kIHx8ICdHRVQnLFxuICAgICAgICBoZWFkZXI6IGNvcHlPcHRpb25zLmhlYWRlcnMsXG4gICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgcmVzID0gZGVhbEFkYXB0ZXJSZXF1ZXN0RGF0YShyZXMsIHsgLi4ub3B0aW9ucywgdXJsIH0pXG5cbiAgICAgICAgICBpZiAocmVzLmVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QocmVzKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXNvbHZlKHJlcylcbiAgICAgICAgfSxcbiAgICAgICAgZmFpbChlcnIpIHtcbiAgICAgICAgICByZWplY3Qoe1xuICAgICAgICAgICAgZXJyb3I6ICd1bnJlYWNoYWJsZScsXG4gICAgICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbjogKGVyciBhcyBFcnJvcikubWVzc2FnZSxcbiAgICAgICAgICB9KVxuICAgICAgICB9LFxuICAgICAgICBjb21wbGV0ZShlcnIpIHtcbiAgICAgICAgICBpZiAoIWVyciB8fCAhZXJyLmVyck1zZykge1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghcmVxQ2xhc3MuX3RpbWVvdXQgfHwgcmVxQ2xhc3MuX3Jlc3RyaWN0ZWRNZXRob2RzLmluZGV4T2YoJ3JlcXVlc3QnKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCB7IGVyck1zZyB9ID0gZXJyXG4gICAgICAgICAgaWYgKGVyck1zZyA9PT0gJ3JlcXVlc3Q6ZmFpbCB0aW1lb3V0Jykge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKHJlcUNsYXNzLl90aW1lb3V0TXNnKVxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgdGFzay5hYm9ydCgpXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7fVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuXG4vKipcbiAqIEdldCB1cmwgcGF0aC5cbiAqIEBwYXJhbSB7c3RyaW5nfSB1cmxcbiAqIEByZXR1cm4ge3N0cmluZ31cbiAqL1xuZnVuY3Rpb24gZ2V0VXJsUGF0aCh1cmw6IHN0cmluZykge1xuICAvLyByZXR1cm4gcGF0aCBpZiBtYXRjaGVkLCBvciBvcmlnaW5hbCB1cmxcbiAgcmV0dXJuIFVSTF9SRUcudGVzdCh1cmwpID8gUmVnRXhwLiQxIDogdXJsXG59XG5cbi8qKlxuICog55So5oi36Ieq5a6a5LmJYWRhcHRlcuWkhOeQhlxuICogQHBhcmFtIGNvbmZpZ1xuICogQHBhcmFtIGFkYXB0ZXJcbiAqIEByZXR1cm5zXG4gKi9cbmNvbnN0IGRlYWxVc2VyQWRhcHRlciA9IChjb25maWc6IEF1dGhPcHRpb25zLCBhZGFwdGVyOiBTREtBZGFwdGVySW50ZXJmYWNlKSA9PiB7XG4gIGNvbnN0IGRhdGEgPSB7IC4uLmNvbmZpZyB9XG5cbiAgdHJ5IHtcbiAgICBpZiAoIWNvbmZpZz8uc3RvcmFnZSAmJiBhZGFwdGVyPy5sb2NhbFN0b3JhZ2UpIHtcbiAgICAgIGRhdGEuc3RvcmFnZSA9IG5ldyBPYXV0aENsaWVudFN0b3JhZ2VCYXNlKHsgbG9jYWxTdG9yYWdlOiBhZGFwdGVyLmxvY2FsU3RvcmFnZSwgYWRhcHRlciB9KVxuICAgIH1cblxuICAgIGlmICghY29uZmlnLmNhcHRjaGFPcHRpb25zICYmIGFkYXB0ZXI/LmNhcHRjaGFPcHRpb25zKSB7XG4gICAgICBkYXRhLmNhcHRjaGFPcHRpb25zID0gYWRhcHRlci5jYXB0Y2hhT3B0aW9uc1xuICAgIH1cblxuICAgIC8vIOeUqOaIt+acquS8oOWFpWJhc2VSZXF1ZXN05ZKMcmVxdWVzdOaXtuWkhOeQhlxuICAgIC8vIE9BdXRoMkNsaWVudOS8mOWFiOS7pSBiYXNlUmVxdWVzdCDkuLrlh4ZcbiAgICAvLyBBdXRoIOWcqOayoeaciSByZXF1ZXN0IOeahOaXtuWAmeS8muWIneWni+WMliBDYXB0Y2hh77yM5LuO6ICM5L2/55SoIENhcHRjaGEg55qEIHJlcXVlc3RcbiAgICBpZiAoIWNvbmZpZy5iYXNlUmVxdWVzdCAmJiAhY29uZmlnLnJlcXVlc3QgJiYgYWRhcHRlcj8ucmVxQ2xhc3MpIHtcbiAgICAgIGNvbnN0IHJlcUNsYXNzUGFyYW1zID0ge1xuICAgICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICAgICAgcmVzdHJpY3RlZE1ldGhvZHM6IFsnZ2V0JywgJ3Bvc3QnLCAndXBsb2FkJywgJ2Rvd25sb2FkJywgJ3JlcXVlc3QnXSxcbiAgICAgIH1cbiAgICAgIGNvbnN0IGFkYXB0ZXJSZXEgPSBuZXcgYWRhcHRlci5yZXFDbGFzcyhyZXFDbGFzc1BhcmFtcylcbiAgICAgIGRhdGEuYmFzZVJlcXVlc3QgPSBhc3luYyBmdW5jdGlvbiAodXJsOiBzdHJpbmcsIG9wdGlvbnM/OiB7IG1ldGhvZD86IHN0cmluZzsgW2tleTogc3RyaW5nXTogYW55IH0pIHtcbiAgICAgICAgbGV0IHJlczogYW55ID0ge31cblxuICAgICAgICBjb25zdCByZXF1ZXN0VHlwZSA9IG9wdGlvbnMubWV0aG9kPy50b0xvY2FsZUxvd2VyQ2FzZSgpIHx8ICdwb3N0J1xuXG4gICAgICAgIGNvbnN0IGZ1bmMgPSBhZGFwdGVyUmVxPy5bcmVxdWVzdFR5cGVdPy5iaW5kPy4oYWRhcHRlclJlcSlcblxuICAgICAgICBpZiAodHlwZW9mIGZ1bmMgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQg44CQJHtyZXF1ZXN0VHlwZX3jgJEgcmVxdWVzdCBtZXRob2RgKVxuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyDlhbzlrrnpnZ7lsI/nqIvluo/nmoRhZGFwdGVyXG4gICAgICAgICAgaWYgKCghb3B0aW9ucy5oZWFkZXJzPy5bJ2NvbnRlbnQtdHlwZSddIHx8IG9wdGlvbnMuaGVhZGVycz8uWydjb250ZW50LXR5cGUnXS5pbmNsdWRlcygnYXBwbGljYXRpb24vanNvbicpKSAmJiAhWydzdHJpbmcnLCAndW5kZWZpbmVkJ10uaW5jbHVkZXModHlwZW9mIG9wdGlvbnMuYm9keSkpIHtcbiAgICAgICAgICAgIG9wdGlvbnMuZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCBvcHRpb25zLmJvZHlcbiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYm9keSlcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzID0gYXdhaXQgZnVuYyh7IHVybCwgLi4ub3B0aW9ucyB9KVxuICAgICAgICAgIHJlcyA9IGRlYWxBZGFwdGVyUmVxdWVzdERhdGEocmVzLCB7IC4uLm9wdGlvbnMsIHVybCB9KVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIHJlcyA9IHsgLi4uZXJyb3I/LmRhdGEsIC4uLmVycm9yIH1cbiAgICAgICAgICB0aHJvdyByZXNcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXM/LmVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgcmVzXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzXG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5lcnJvcigndXNlciBhZGFwdGVyIGdlbmVyYXRlIGZhaWw6JywgZSlcbiAgfVxuXG4gIHJldHVybiBkYXRhXG59XG5cbi8qKlxuICog5YaF572u6buY6K6kYWRhcHRlcuWkhOeQhlxuICogQHBhcmFtIGNvbmZpZ1xuICogQHJldHVybnNcbiAqL1xuY29uc3QgZGVhbEF1dGhBZGFwdGVyID0gKGNvbmZpZzogQXV0aE9wdGlvbnMsIGFkYXB0ZXI6IFNES0FkYXB0ZXJJbnRlcmZhY2UpID0+IHtcbiAgY29uc3QgZGF0YSA9IHsgLi4uY29uZmlnIH1cbiAgY29uc3QgYXV0aE9wdGlvbnM6IGFueSA9IHt9XG5cbiAgaWYgKGFkYXB0ZXI/LmNhcHRjaGFPcHRpb25zKSB7XG4gICAgZGF0YS5jYXB0Y2hhT3B0aW9ucyA9IGFkYXB0ZXIuY2FwdGNoYU9wdGlvbnNcbiAgfVxuXG4gIGlmICghYWRhcHRlckZvcld4TXAuaXNNYXRjaCgpIHx8IChjb25maWcuc3RvcmFnZSAmJiBjb25maWcuYmFzZVJlcXVlc3QpKSByZXR1cm4gZGF0YVxuXG4gIHRyeSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICAgIGNvbnN0IHsgbG9jYWxTdG9yYWdlLCByZXFDbGFzczogUmVxQ2xhc3MgfSA9IGFkYXB0ZXJGb3JXeE1wLmdlbkFkYXB0ZXIoe30pXG4gICAgaWYgKGxvY2FsU3RvcmFnZSkge1xuICAgICAgYXV0aE9wdGlvbnMuc3RvcmFnZSA9IG5ldyBPYXV0aENsaWVudFN0b3JhZ2VCYXNlKHsgbG9jYWxTdG9yYWdlLCBhZGFwdGVyIH0pXG4gICAgfVxuICAgIGlmIChSZXFDbGFzcykge1xuICAgICAgY29uc3QgcmVxQ2xhc3MgPSBuZXcgUmVxQ2xhc3Moe1xuICAgICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICAgICAgcmVzdHJpY3RlZE1ldGhvZHM6IFsnZ2V0JywgJ3Bvc3QnLCAndXBsb2FkJywgJ2Rvd25sb2FkJywgJ3JlcXVlc3QnXSxcbiAgICAgIH0pXG4gICAgICBhdXRoT3B0aW9ucy5yZXF1ZXN0ID0gZ2VuZXJhdGVPYXV0aENsaWVudFJlcXVlc3QocmVxQ2xhc3MpXG4gICAgfVxuXG4gICAgaWYgKGRhdGEuY2FwdGNoYU9wdGlvbnMpIHtcbiAgICAgIGF1dGhPcHRpb25zLmJhc2VSZXF1ZXN0ID0gYXV0aE9wdGlvbnMucmVxdWVzdFxuICAgICAgYXV0aE9wdGlvbnMucmVxdWVzdCA9IHVuZGVmaW5lZFxuICAgIH1cblxuICAgIHJldHVybiB7IC4uLmRhdGEsIC4uLmF1dGhPcHRpb25zIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ2FkYXB0ZXIgZ2VuZXJhdGUgZmFpbDonLCBlKVxuICB9XG5cbiAgcmV0dXJuIGRhdGFcbn1cblxuZXhwb3J0IGNvbnN0IHVzZUF1dGhBZGFwdGVyID0gKGNvbmZpZzogQXV0aE9wdGlvbnMpID0+IHtcbiAgLy8g5YW85a655b6u5pCtY2xvdWQtc2Rr77yMYXV0aOS4rWpzLXNka+m7mOiupOeahGFkYXB0ZXLkuI3ov5vooYzphY3nva5cbiAgaWYgKGNvbmZpZy5hZGFwdGVyICYmIChjb25maWcuYWRhcHRlciBhcyBhbnkpLnR5cGUgIT09ICdkZWZhdWx0Jykge1xuICAgIHJldHVybiBkZWFsVXNlckFkYXB0ZXIoY29uZmlnLCBjb25maWcuYWRhcHRlcilcbiAgfVxuXG4gIHJldHVybiBkZWFsQXV0aEFkYXB0ZXIoY29uZmlnLCBjb25maWcuYWRhcHRlcilcbn1cbiJdfQ==