import { weAtob } from './base64';
import { getConfig } from './common';
import { commonLocalStorage } from './storage';
/**
 * 该函数用于处理 signIn 和 getUserInfo 的缓存
 * 用户访问页面相关信息采用swr机制，进入页面优先使用缓存数据，后更新缓存，对于同一envId、clientId、userType、phone采用覆盖更新
 * @param param0
 * @returns
 */
export async function dealCache({ key, getTcbInstance, value = '', type = 'get' }) {
    var _a;
    if (!commonLocalStorage || !key)
        return undefined;
    try {
        const { auth } = await getTcbInstance();
        const { envID: env = '', tcbClientId: clientId = '' } = getConfig();
        const { accessToken = '' } = (await auth.getAccessToken()) || {};
        const { user_id = '', sub = '', scope = '' } = parseWedaAccessToken(accessToken);
        // 缓存值为对象，用于区分不同的平台和环境的用户信息，{ [cacheKey]: { [userKey]: value } }
        const cacheKey = `${env}-${clientId}`;
        const userKey = `${scope}_${user_id || sub}`;
        const cache = JSON.parse(commonLocalStorage.getItemSync(key) || '{}');
        // 清空时直接清空
        if (type === 'remove') {
            delete cache[cacheKey];
            commonLocalStorage.setItemSync(key, JSON.stringify(cache));
            return;
        }
        // 如果缓存key不带有任何用户特征，则不处理
        if (userKey === '_') {
            return;
        }
        if (type === 'get') {
            return (_a = cache[cacheKey]) === null || _a === void 0 ? void 0 : _a[userKey];
        }
        if (type === 'set') {
            commonLocalStorage.setItemSync(key, JSON.stringify(Object.assign(Object.assign({}, cache), { [cacheKey]: { [userKey]: value } })));
            return;
        }
    }
    catch (error) {
        return undefined;
    }
}
/**
 * 解析weda的accessToken
 * @param wedaAccessToken
 * @returns
 */
export const parseWedaAccessToken = (wedaAccessToken) => {
    var _a, _b;
    try {
        const payload = weAtob((_b = (_a = wedaAccessToken.split('.')) === null || _a === void 0 ? void 0 : _a[1]) === null || _b === void 0 ? void 0 : _b.replace(/-/g, '+').replace(/_/g, '/'));
        return JSON.parse(payload) || {};
    }
    catch (error) {
        return {};
    }
};
