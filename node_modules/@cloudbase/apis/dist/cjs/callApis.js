"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateApis = exports.generateCallApis = exports.callApi = void 0;
var constants_1 = require("@cloudbase/utilities/dist/cjs/constants");
function callApi(callApiOptions, opts) {
    var _a, _b, _c;
    return __awaiter(this, void 0, void 0, function () {
        var _d, name, body, _e, path, _f, method, _g, headers, token, url, _h, gatewayOrigin, getAccessToken, env, _j, BASE_URL, PROTOCOL, endpoint, reqPath, accessToken, response;
        return __generator(this, function (_k) {
            switch (_k.label) {
                case 0:
                    _d = callApiOptions || {}, name = _d.name, body = _d.body, _e = _d.path, path = _e === void 0 ? '' : _e, _f = _d.method, method = _f === void 0 ? 'POST' : _f, _g = _d.headers, headers = _g === void 0 ? {} : _g;
                    token = (callApiOptions || {}).token;
                    if (!name) {
                        throw new Error(JSON.stringify({
                            code: constants_1.ERRORS.INVALID_PARAMS,
                            msg: '[apis] invalid api name',
                        }));
                    }
                    url = '';
                    _h = this, gatewayOrigin = _h.gatewayOrigin, getAccessToken = _h.getAccessToken, env = _h.env;
                    if (gatewayOrigin) {
                        url = "".concat(gatewayOrigin, "/v1");
                    }
                    else if (this.getEndPointWithKey) {
                        _j = this.getEndPointWithKey('GATEWAY'), BASE_URL = _j.BASE_URL, PROTOCOL = _j.PROTOCOL;
                        url = "".concat(PROTOCOL).concat(BASE_URL);
                    }
                    else {
                        url = "https://".concat(env, ".api.tcloudbasegateway.com/v1");
                    }
                    endpoint = "".concat(url, "/apis/").concat(name);
                    reqPath = path.startsWith('/') ? path : "/".concat(path);
                    if (!getAccessToken) return [3, 2];
                    return [4, getAccessToken()];
                case 1:
                    accessToken = (_k.sent()).accessToken;
                    headers.Authorization = "Bearer ".concat(accessToken);
                    _k.label = 2;
                case 2: return [4, this.request.fetch(__assign({ url: "".concat(endpoint).concat(reqPath), method: method || 'POST', headers: __assign({ 'Content-Type': 'application/json; charset=utf-8' }, headers), body: body, token: ((_a = token === null || token === void 0 ? void 0 : token.trim) === null || _a === void 0 ? void 0 : _a.call(token)) || ((_c = (_b = headers.Authorization) === null || _b === void 0 ? void 0 : _b.replace) === null || _c === void 0 ? void 0 : _c.call(_b, /^Bearer /, '')) || null }, opts))];
                case 3:
                    response = _k.sent();
                    return [4, response.data];
                case 4: return [2, _k.sent()];
            }
        });
    });
}
exports.callApi = callApi;
var SUPPORT_METHODS = ['GET', 'POST', 'PUT', 'DELETE', 'HEAD', 'OPTIONS', 'PATCH', 'REQUEST'];
function generateCallApis(apiName) {
    var _this = this;
    return new Proxy({}, {
        get: function (_, method) {
            if (typeof method !== 'string') {
                throw new Error('[apis] method must be string');
            }
            var upMethod = method.toLocaleUpperCase();
            if (!SUPPORT_METHODS.includes(upMethod)) {
                throw new Error("[apis] invalid method: ".concat(method));
            }
            return function (callApiOptions, opts) { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0: return [4, callApi.call(this, __assign({ name: apiName, method: (upMethod === 'REQUEST' ? callApiOptions.method : upMethod) || 'POST' }, callApiOptions), opts)];
                        case 1: return [2, _a.sent()];
                    }
                });
            }); };
        },
    });
}
exports.generateCallApis = generateCallApis;
function generateApis(params) {
    var _this = this;
    Object.keys(params || {}).forEach(function (key) {
        if (params[key] !== undefined)
            _this[key] = params[key];
    });
    return new Proxy({}, {
        get: function (_, apiName) {
            if (typeof apiName === 'string') {
                return generateCallApis.call(_this, apiName);
            }
        },
    });
}
exports.generateApis = generateApis;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsbEFwaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2FsbEFwaXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxRUFBZ0U7QUFJaEUsU0FBc0IsT0FBTyxDQUFDLGNBQStCLEVBQUUsSUFBYzs7Ozs7OztvQkFDckUsS0FBMkQsY0FBYyxJQUFJLEVBQUUsRUFBN0UsSUFBSSxVQUFBLEVBQUUsSUFBSSxVQUFBLEVBQUUsWUFBUyxFQUFULElBQUksbUJBQUcsRUFBRSxLQUFBLEVBQUUsY0FBZSxFQUFmLE1BQU0sbUJBQUcsTUFBTSxLQUFBLEVBQUUsZUFBWSxFQUFaLE9BQU8sbUJBQUcsRUFBRSxLQUFBLENBQXlCO29CQUM3RSxLQUFLLEdBQUssQ0FBQSxjQUFjLElBQUksRUFBRSxDQUFBLE1BQXpCLENBQXlCO29CQUV0QyxJQUFJLENBQUMsSUFBSSxFQUFFO3dCQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQzs0QkFDN0IsSUFBSSxFQUFFLGtCQUFNLENBQUMsY0FBYzs0QkFDM0IsR0FBRyxFQUFFLHlCQUF5Qjt5QkFDL0IsQ0FBQyxDQUFFLENBQUE7cUJBQ0w7b0JBRUcsR0FBRyxHQUFHLEVBQUUsQ0FBQTtvQkFFTixLQUF5QyxJQUFJLEVBQTNDLGFBQWEsbUJBQUEsRUFBRSxjQUFjLG9CQUFBLEVBQUUsR0FBRyxTQUFBLENBQVM7b0JBRW5ELElBQUksYUFBYSxFQUFFO3dCQUNqQixHQUFHLEdBQUcsVUFBRyxhQUFhLFFBQUssQ0FBQTtxQkFDNUI7eUJBQU0sSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7d0JBQzVCLEtBQXlCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsRUFBekQsUUFBUSxjQUFBLEVBQUUsUUFBUSxjQUFBLENBQXVDO3dCQUNqRSxHQUFHLEdBQUcsVUFBRyxR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QUFBO0lBRUYsT0FBTyxJQUFJLEtBQUssQ0FDZCxFQUFFLEVBQ0Y7UUFDRSxHQUFHLEVBQUUsVUFBQyxDQUFDLEVBQUUsT0FBTztZQUNkLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO2dCQUMvQixPQUFPLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7YUFDNUM7UUFDSCxDQUFDO0tBQ0YsQ0FDRixDQUFBO0FBQ0gsQ0FBQztBQXBCRCxvQ0FvQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFUlJPUlMgfSBmcm9tICdAY2xvdWRiYXNlL3V0aWxpdGllcy9kaXN0L2Nqcy9jb25zdGFudHMnXG5pbXBvcnQgeyBJQ2FsbEFwaU9wdGlvbnMsIEtWIH0gZnJvbSAnQGNsb3VkYmFzZS90eXBlcydcbmltcG9ydCB7IFJlc3BvbnNlT2JqZWN0LCBTREtSZXF1ZXN0SW50ZXJmYWNlIH0gZnJvbSAnQGNsb3VkYmFzZS9hZGFwdGVyLWludGVyZmFjZSdcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbGxBcGkoY2FsbEFwaU9wdGlvbnM6IElDYWxsQXBpT3B0aW9ucywgb3B0cz86IEtWPGFueT4pOiBQcm9taXNlPFJlc3BvbnNlT2JqZWN0WydkYXRhJ10+IHtcbiAgY29uc3QgeyBuYW1lLCBib2R5LCBwYXRoID0gJycsIG1ldGhvZCA9ICdQT1NUJywgaGVhZGVycyA9IHt9IH0gPSBjYWxsQXBpT3B0aW9ucyB8fCB7fVxuICBjb25zdCB7IHRva2VuIH0gPSBjYWxsQXBpT3B0aW9ucyB8fCB7fVxuXG4gIGlmICghbmFtZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeSh7XG4gICAgICBjb2RlOiBFUlJPUlMuSU5WQUxJRF9QQVJBTVMsXG4gICAgICBtc2c6ICdbYXBpc10gaW52YWxpZCBhcGkgbmFtZScsXG4gICAgfSksKVxuICB9XG5cbiAgbGV0IHVybCA9ICcnXG5cbiAgY29uc3QgeyBnYXRld2F5T3JpZ2luLCBnZXRBY2Nlc3NUb2tlbiwgZW52IH0gPSB0aGlzXG5cbiAgaWYgKGdhdGV3YXlPcmlnaW4pIHtcbiAgICB1cmwgPSBgJHtnYXRld2F5T3JpZ2lufS92MWBcbiAgfSBlbHNlIGlmICh0aGlzLmdldEVuZFBvaW50V2l0aEtleSkge1xuICAgIGNvbnN0IHsgQkFTRV9VUkwsIFBST1RPQ09MIH0gPSB0aGlzLmdldEVuZFBvaW50V2l0aEtleSgnR0FURVdBWScpXG4gICAgdXJsID0gYCR7UFJPVE9DT0x9JHtCQVNFX1VSTH1gXG4gIH0gZWxzZSB7XG4gICAgdXJsID0gYGh0dHBzOi8vJHtlbnZ9LmFwaS50Y2xvdWRiYXNlZ2F0ZXdheS5jb20vdjFgXG4gIH1cbiAgY29uc3QgZW5kcG9pbnQgPSBgJHt1cmx9L2FwaXMvJHtuYW1lfWBcbiAgY29uc3QgcmVxUGF0aCA9IHBhdGguc3RhcnRzV2l0aCgnLycpID8gcGF0aCA6IGAvJHtwYXRofWBcblxuICBpZiAoZ2V0QWNjZXNzVG9rZW4pIHtcbiAgICBjb25zdCB7IGFjY2Vzc1Rva2VuIH0gPSAoYXdhaXQgZ2V0QWNjZXNzVG9rZW4oKSlcbiAgICBoZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgQmVhcmVyICR7YWNjZXNzVG9rZW59YFxuICB9XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnJlcXVlc3QuZmV0Y2goe1xuICAgIHVybDogYCR7ZW5kcG9pbnR9JHtyZXFQYXRofWAsXG4gICAgbWV0aG9kOiBtZXRob2QgfHwgJ1BPU1QnLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAuLi5oZWFkZXJzLFxuICAgIH0sXG4gICAgYm9keSxcbiAgICB0b2tlbjogdG9rZW4/LnRyaW0/LigpIHx8IGhlYWRlcnMuQXV0aG9yaXphdGlvbj8ucmVwbGFjZT8uKC9eQmVhcmVyIC8sICcnKSB8fCBudWxsLFxuICAgIC4uLm9wdHMsXG4gIH0pXG5cbiAgcmV0dXJuIGF3YWl0IHJlc3BvbnNlLmRhdGFcbn1cblxuY29uc3QgU1VQUE9SVF9NRVRIT0RTID0gWydHRVQnLCAnUE9TVCcsICdQVVQnLCAnREVMRVRFJywgJ0hFQUQnLCAnT1BUSU9OUycsICdQQVRDSCcsICdSRVFVRVNUJ11cbmRlY2xhcmUgdHlwZSBNZXRob2RUeXBlID0gJ3JlcXVlc3QnIHwgJ3Bvc3QnIHwgJ2dldCcgfCAnaGVhZCcgfCAncGF0Y2gnIHwgJ2RlbGV0ZScgfCAncHV0JztcblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlQ2FsbEFwaXMoYXBpTmFtZTogc3RyaW5nKTogeyBbbWV0aG9kIGluIE1ldGhvZFR5cGVdOiB0eXBlb2YgY2FsbEFwaSB9IHtcbiAgcmV0dXJuIG5ldyBQcm94eSh7fSBhcyBhbnksIHtcbiAgICBnZXQ6IChfLCBtZXRob2QpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgbWV0aG9kICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1thcGlzXSBtZXRob2QgbXVzdCBiZSBzdHJpbmcnKVxuICAgICAgfVxuXG4gICAgICBjb25zdCB1cE1ldGhvZCA9IG1ldGhvZC50b0xvY2FsZVVwcGVyQ2FzZSgpXG5cbiAgICAgIGlmICghU1VQUE9SVF9NRVRIT0RTLmluY2x1ZGVzKHVwTWV0aG9kKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFthcGlzXSBpbnZhbGlkIG1ldGhvZDogJHttZXRob2R9YClcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFzeW5jIChjYWxsQXBpT3B0aW9uczogSUNhbGxBcGlPcHRpb25zLCBvcHRzOiBLVjxhbnk+KSA9PiBhd2FpdCBjYWxsQXBpLmNhbGwoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiBhcGlOYW1lLFxuICAgICAgICAgIG1ldGhvZDogKHVwTWV0aG9kID09PSAnUkVRVUVTVCcgPyBjYWxsQXBpT3B0aW9ucy5tZXRob2QgOiB1cE1ldGhvZCkgfHwgJ1BPU1QnLFxuICAgICAgICAgIC4uLmNhbGxBcGlPcHRpb25zLFxuICAgICAgICB9LFxuICAgICAgICBvcHRzLFxuICAgICAgKVxuICAgIH0sXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUFwaXMocGFyYW1zPzoge1xuICBlbnY/OiBzdHJpbmc7XG4gIHJlcXVlc3Q/OiBTREtSZXF1ZXN0SW50ZXJmYWNlO1xuICBnYXRld2F5T3JpZ2luPzogc3RyaW5nO1xuICBnZXRBY2Nlc3NUb2tlbj86ICgpID0+IFByb21pc2U8eyBhY2Nlc3NUb2tlbjogc3RyaW5nIH0+O1xufSk6IHsgW2FwaU5hbWU6IHN0cmluZ106IHsgW21ldGhvZCBpbiBNZXRob2RUeXBlXTogdHlwZW9mIGNhbGxBcGkgfSB9IHtcbiAgT2JqZWN0LmtleXMocGFyYW1zIHx8IHt9KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBpZiAocGFyYW1zW2tleV0gIT09IHVuZGVmaW5lZCkgdGhpc1trZXldID0gcGFyYW1zW2tleV1cbiAgfSlcblxuICByZXR1cm4gbmV3IFByb3h5KFxuICAgIHt9LFxuICAgIHtcbiAgICAgIGdldDogKF8sIGFwaU5hbWUpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBhcGlOYW1lID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHJldHVybiBnZW5lcmF0ZUNhbGxBcGlzLmNhbGwodGhpcywgYXBpTmFtZSlcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9LFxuICApXG59XG4iXX0=