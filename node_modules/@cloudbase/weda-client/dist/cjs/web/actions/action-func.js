"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.actionSdk = exports.hideLoading = exports.showLoading = exports.hideToast = exports.showToast = void 0;
const utils_1 = require("./utils");
const app_h5_sdk_1 = __importDefault(require("@tcwd/weapps-sdk/lib/app-h5-sdk"));
let noop = function () { };
class Toast {
    options;
    style;
    el;
    mask;
    icon;
    toast;
    title;
    type;
    hideOpacityTimer;
    hideDisplayTimer;
    constructor() {
        this.options = {
            title: '',
            icon: 'none',
            image: '',
            duration: 1500,
            mask: false,
            success: noop,
            fail: noop,
            complete: noop,
            document,
        };
        this.style = {
            maskStyle: {
                position: 'fixed',
                'z-index': '1000',
                top: '0',
                right: '0',
                left: '0',
                bottom: '0',
            },
            toastStyle: {
                'z-index': '5000',
                'box-sizing': 'border-box',
                display: 'flex',
                'flex-direction': 'column',
                'justify-content': 'center',
                '-webkit-justify-content': 'center',
                position: 'fixed',
                top: '50%',
                left: '50%',
                'min-width': (0, utils_1.calPxToREM)(120),
                'max-width': (0, utils_1.calPxToREM)(200),
                'min-height': (0, utils_1.calPxToREM)(120),
                padding: (0, utils_1.calPxToREM)(15),
                transform: 'translate(-50%, -50%)',
                'border-radius': (0, utils_1.calPxToREM)(5),
                'text-align': 'center',
                'line-height': '1.6',
                color: '#FFFFFF',
                background: 'rgba(17, 17, 17, 0.7)',
            },
            successStyle: {
                margin: '0',
                'vertical-align': 'middle',
                'font-family': 'weapps',
                '-webkit-font-smoothing': 'antialiased',
                color: '#FFFFFF',
                'font-size': (0, utils_1.calPxToREM)(55),
                'line-height': '1',
            },
            loadingStyle: {
                margin: `${(0, utils_1.calPxToREM)(6)} auto`,
                width: (0, utils_1.calPxToREM)(38),
                height: (0, utils_1.calPxToREM)(38),
                '-webkit-animation': 'weappsLoading 1s steps(12, end) infinite',
                animation: 'weappsLoading 1s steps(12, end) infinite',
                background: 'transparent url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHBhdGggZmlsbD0ibm9uZSIgZD0iTTAgMGgxMDB2MTAwSDB6Ii8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjRTlFOUU5IiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAgLTMwKSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iIzk4OTY5NyIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgzMCAxMDUuOTggNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjOUI5OTlBIiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKDYwIDc1Ljk4IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0EzQTFBMiIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSg5MCA2NSA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNBQkE5QUEiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDU4LjY2IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0IyQjJCMiIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgxNTAgNTQuMDIgNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjQkFCOEI5IiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKDE4MCA1MCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNDMkMwQzEiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1MCA0NS45OCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNDQkNCQ0IiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTEyMCA0MS4zNCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNEMkQyRDIiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTkwIDM1IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0RBREFEQSIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgtNjAgMjQuMDIgNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjRTJFMkUyIiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKC0zMCAtNS45OCA2NSkiLz48L3N2Zz4=) no-repeat',
                'background-size': '100%',
            },
            imageStyle: {
                margin: `${(0, utils_1.calPxToREM)(6)} auto`,
                width: (0, utils_1.calPxToREM)(40),
                height: (0, utils_1.calPxToREM)(40),
                background: 'transparent no-repeat',
                'background-size': '100%',
            },
            textStyle: {
                margin: '0',
                'font-size': (0, utils_1.calPxToREM)(16),
            },
            pcToastStyle: {
                'z-index': '5000',
                height: (0, utils_1.calPxToREM)(30),
                position: 'fixed',
                display: 'inline-flex',
                '-webkit-box-align': 'center',
                '-ms-flex-align': 'center',
                'align-items': 'center',
                'text-align': 'left',
                top: (0, utils_1.calPxToREM)(5),
                left: '50%',
                '-webkit-transform': 'translate(-50%)',
                transform: 'translate(-50%)',
                'line-height': (0, utils_1.calPxToREM)(30),
                padding: `0 ${(0, utils_1.calPxToREM)(18)}`,
                overflow: 'hidden',
                'white-space': 'nowrap',
                'word-wrap': 'break-word',
                'word-break': 'break-word',
                border: '1px solid #cfd5de',
                'border-radius': 0,
                'font-size': 0,
                'background-color': '#fff',
                color: 'rgba(0,0,0,.9)',
            },
            pcLoadingStyle: {
                background: 'transparent url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTggMTZBOCA4IDAgMSAxIDggMHYyYTYgNiAwIDEgMCA2IDZoMmE4IDggMCAwIDEtOCA4eiIgZmlsbD0iIzAwNmVmZiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+) no-repeat',
                'background-size': '100%',
                '-webkit-animation': 'weappsLoading .6s steps(12, end) infinite',
                animation: 'weappsLoading .6s steps(12, end) infinite',
                width: '16px',
                height: '16px',
            },
            pcTextStyle: {
                margin: '0 0 0 6px',
                'font-size': (0, utils_1.calPxToREM)(12),
            },
        };
    }
    create(options, type = 'h5') {
        if (options === void 0) {
            options = {};
        }
        // style
        let { maskStyle, toastStyle, successStyle, loadingStyle, imageStyle, textStyle, pcToastStyle, pcLoadingStyle, pcTextStyle, } = this.style;
        // configuration
        let config = { ...this.options, ...options };
        // wrapper
        this.el = config.document.createElement('div');
        this.el.className = 'weapps__toast wd-toast';
        this.el.style.opacity = '0';
        this.el.style.transition = 'opacity 0.1s linear';
        // mask
        this.mask = config.document.createElement('div');
        this.mask.className = 'wd-toast__mask';
        this.mask.setAttribute('style', (0, utils_1.inlineStyle)(maskStyle));
        this.mask.style.display = config.mask && type === 'h5' ? 'block' : 'none';
        // icon
        this.icon = config.document.createElement('p');
        this.icon.className = 'wd-toast__icon';
        if (config.image) {
            this.icon.setAttribute('style', (0, utils_1.inlineStyle)({ ...imageStyle, 'background-image': `url(${config.image})` }));
        }
        else {
            let iconStyle = config.icon === 'loading' ? (type === 'h5' ? loadingStyle : pcLoadingStyle) : successStyle;
            this.icon.setAttribute('style', (0, utils_1.inlineStyle)({ ...iconStyle, ...(config.icon === 'none' ? { display: 'none' } : {}) }));
            if (config.icon !== 'loading')
                this.icon.textContent = '';
        }
        // toast
        this.toast = config.document.createElement('div');
        this.toast.className = 'wd-toast__body';
        this.toast.setAttribute('style', (0, utils_1.inlineStyle)({
            ...(type === 'h5' ? toastStyle : pcToastStyle),
            ...(config.icon === 'none'
                ? {
                    'min-height': '0',
                    padding: `${(0, utils_1.calPxToREM)(10)} ${(0, utils_1.calPxToREM)(15)}`,
                }
                : {}),
        }));
        // title
        this.title = config.document.createElement('p');
        this.title.className = 'wd-toast__title';
        this.title.setAttribute('style', (0, utils_1.inlineStyle)(type === 'h5' ? textStyle : pcTextStyle));
        this.title.textContent = config.title;
        // result
        this.toast.appendChild(this.icon);
        this.toast.appendChild(this.title);
        this.el.appendChild(this.mask);
        this.el.appendChild(this.toast);
        // show immediately
        config.document.body.appendChild(this.el);
        setTimeout(() => {
            this.el.style.opacity = '1';
        }, 0);
        this.type = config._type;
        // disappear after duration
        config.duration >= 0 && this.hide(config.duration, this.type);
        let errMsg = this.type === 'loading' ? 'showLoading:ok' : 'showToast:ok';
        config.success?.({ errMsg });
        config.complete?.({ errMsg });
        return Promise.resolve({ errMsg });
    }
    show(options, type = 'h5') {
        if (options === void 0) {
            options = {};
        }
        let config = { ...this.options, ...options };
        if (this.hideOpacityTimer)
            clearTimeout(this.hideOpacityTimer);
        if (this.hideDisplayTimer)
            clearTimeout(this.hideDisplayTimer);
        // title
        this.title.textContent = config.title || '';
        // mask
        this.mask.style.display = config.mask && type === 'h5' ? 'block' : 'none';
        // image
        let { toastStyle, successStyle, loadingStyle, imageStyle, pcLoadingStyle, pcToastStyle } = this.style;
        if (config.image) {
            this.icon.setAttribute('style', (0, utils_1.inlineStyle)({ ...imageStyle, 'background-image': `url(${config.image})` }));
            this.icon.textContent = '';
        }
        else {
            if (!config.image && config.icon) {
                let iconStyle = config.icon === 'loading' ? (type === 'h5' ? loadingStyle : pcLoadingStyle) : successStyle;
                this.icon.setAttribute('style', (0, utils_1.inlineStyle)({ ...iconStyle, ...(config.icon === 'none' ? { display: 'none' } : {}) }));
                this.icon.textContent = config.icon === 'loading' ? '' : '';
            }
        }
        // toast
        this.toast.setAttribute('style', (0, utils_1.inlineStyle)({
            ...(type === 'h5' ? toastStyle : pcToastStyle),
            ...(config.icon === 'none'
                ? {
                    'min-height': '0',
                    padding: `${(0, utils_1.calPxToREM)(10)} ${(0, utils_1.calPxToREM)(15)}`,
                }
                : {}),
        }));
        // show
        this.el.style.display = 'block';
        setTimeout(() => {
            this.el.style.opacity = '1';
        }, 0);
        this.type = config._type;
        // disappear after duration
        config.duration >= 0 && this.hide(config.duration, this.type);
        let errMsg = this.type === 'loading' ? 'showLoading:ok' : 'showToast:ok';
        config.success?.({ errMsg });
        config.complete?.({ errMsg });
        return Promise.resolve({ errMsg });
    }
    hide(duration, type) {
        if (duration === void 0) {
            duration = 0;
        }
        if (this.type !== type)
            return;
        if (this.hideOpacityTimer)
            clearTimeout(this.hideOpacityTimer);
        if (this.hideDisplayTimer)
            clearTimeout(this.hideDisplayTimer);
        this.hideOpacityTimer = setTimeout(() => {
            this.el.style.opacity = '0';
            this.hideDisplayTimer = setTimeout(() => {
                this.el.style.display = 'none';
            }, 100);
        }, duration);
    }
}
let toast = new Toast();
let state = 'default';
// inject necessary style
function init(doc) {
    if (state === 'ready')
        return;
    let weappsStyle = doc.createElement('style');
    // border-top: 1px solid #D5D5D6;
    weappsStyle.textContent =
        '@font-face{font-weight:normal;font-style:normal;font-family:"weapps";src:url("data:application/x-font-ttf;charset=utf-8;base64, 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") format("truetype");}@-webkit-keyframes weappsLoading{0%{-webkit-transform:rotate3d(0, 0, 1, 0deg);}100%{-webkit-transform:rotate3d(0, 0, 1, 360deg);transform:rotate3d(0, 0, 1, 360deg);}}@keyframes weappsLoading{0%{-webkit-transform:rotate3d(0, 0, 1, 0deg);}100%{-webkit-transform:rotate3d(0, 0, 1, 360deg);transform:rotate3d(0, 0, 1, 360deg);}}\n  .weapps-modal__foot:after {\n    content: "";position: absolute;left: 0;top: 0;right: 0;height: 1px;\n    box-shadow: 0 -1px 0 0 #EBEBEB;\n    color: #D5D5D6;-webkit-transform-origin: 0 0;transform-origin: 0 0;-webkit-transform: scaleY(0.5);transform: scaleY(0.5);}\n  .weapps-model__btn:active {background-color: #EEEEEE}\n  .weapps-model__btn:not(:first-child):after\n  {\n    content: "";position: absolute;left: 0;top: 0;\n    width: 1px;bottom: 0;border-left: 2px solid #EBEBEB;\n    color: #D5D5D6;-webkit-transform-origin: 0 0;transform-origin: 0 0;-webkit-transform: scaleX(0.5);transform: scaleX(0.5);}\n  .weapps-actionsheet__cell:not(:first-child):after {content: "";position: absolute;left: 0;top: 0;right: 0;height: 1px;border-top: 1px solid #e5e5e5;color: #e5e5e5;-webkit-transform-origin: 0 0;transform-origin: 0 0;-webkit-transform: scaleY(0.5);transform: scaleY(0.5);}';
    doc.querySelector('head').appendChild(weappsStyle);
    state = 'ready';
}
function showToast(options) {
    if (options === void 0) {
        options = {};
    }
    init((0, utils_1.getDocument)());
    let _default = {
        title: '',
        icon: 'success',
        image: '',
        duration: 1500,
        mask: false,
        document: (0, utils_1.getDocument)(),
    };
    options = Object.assign({}, _default, options);
    options._type = 'toast';
    // verify options
    let handler = (0, utils_1.errorHandler)(options.fail, options.complete);
    if (typeof options.title !== 'string') {
        return handler({
            errMsg: (0, utils_1.getParameterError)({
                name: 'showToast',
                para: 'title',
                correct: 'String',
                wrong: options.title,
            }),
        });
    }
    if (typeof options.duration !== 'number') {
        return handler({
            errMsg: (0, utils_1.getParameterError)({
                name: 'showToast',
                para: 'duration',
                correct: 'Number',
                wrong: options.duration,
            }),
        });
    }
    if (options.image && typeof options.image !== 'string')
        options.image = '';
    options.mask = !!options.mask;
    if (!toast.el || !options.document.documentElement.contains(toast.el)) {
        return toast.create(options);
    }
    return toast.show(options);
}
exports.showToast = showToast;
function hideToast(options) {
    if (options === void 0) {
        options = {};
    }
    if (toast.el) {
        toast.hide(0, 'toast');
    }
    let errMsg = 'hideToast:ok';
    options.success?.({ errMsg });
    options.complete?.({ errMsg });
}
exports.hideToast = hideToast;
function showLoading(options, type = 'h5') {
    if (options === void 0) {
        options = {};
    }
    init((0, utils_1.getDocument)());
    let _default = {
        title: '',
        mask: false,
        document: (0, utils_1.getDocument)(),
    };
    let config = {
        icon: 'loading',
        image: '',
        duration: -1,
    };
    options = Object.assign({}, _default, options, config);
    options._type = 'loading';
    // verify options
    let handler = (0, utils_1.errorHandler)(options.fail, options.complete);
    if (typeof options.title !== 'string') {
        return handler({
            errMsg: (0, utils_1.getParameterError)({
                name: 'showLoading',
                para: 'title',
                correct: 'String',
                wrong: options.title,
            }),
        });
    }
    options.mask = !!options.mask;
    if (!toast.el || !options.document.documentElement.contains(toast.el)) {
        return toast.create(options, type);
    }
    return toast.show(options, type);
}
exports.showLoading = showLoading;
function hideLoading() {
    if (!toast.el)
        return;
    toast.hide(0, 'loading');
}
exports.hideLoading = hideLoading;
app_h5_sdk_1.default.showToast = showToast;
app_h5_sdk_1.default.hideToast = hideToast;
app_h5_sdk_1.default.showLoading = showLoading;
app_h5_sdk_1.default.hideLoading = hideLoading;
exports.actionSdk = app_h5_sdk_1.default;
