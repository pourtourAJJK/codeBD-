**Exploring file scanning**

I need to read some files, and I think using the code-explorer tool for a broad scan is the way to go. I’m planning to comply with any constraints and avoid making edits. I’ll make sure to use the task tool to keep everything organized. This approach should help me gather the right information efficiently! Let's see what I can uncover.
**Preparing report in Chinese**

I'm putting together a markdown report in Chinese, keeping it structured with headings using ###. I’ll ensure I mention any files in backticks and include details like priority and severity. It’s important not to include code blocks, so I’ll stick to regular text. I might reference line numbers as needed. I also need to emphasize that there will be no modifications. Let’s get this report ready!
### 说明
已完成对项目的**全盘扫描与深度诊断**，严格只读分析，**未修改任何代码**。以下输出可直接保存为 `.md` 文件。

---

### 项目代码审查报告

## 一、总体结论与风险概览
- **结论**：项目整体功能较完整，但在**登录态、订单字段一致性、支付回调安全、云函数返回规范**等关键环节存在高风险问题，可能导致**支付失败、订单无法查询、状态错乱、信息安全风险**。
- **最高优先级风险**集中在：**订单字段 `openId/openid` 不一致、支付回调密钥硬编码、订单查询/支付验证逻辑不一致**。

---

## 二、目录结构与代码规范检查
### 主要问题
- **云函数命名与内容错位**：`cloudfunctions/order-getOrders/index.js` 实际为“创建订单”逻辑，命名与内容不匹配，易引发调用错误。
- **API 返回结构不统一**：`{success:true}`、`{code:0}`、`{msg:''}` 混用，前端多处判断逻辑不一致。
- **多环境配置不一致**：`app.js` 里 `wx.cloud.init` 使用硬编码环境 ID，未统一使用 `config` 中 `cloudEnv`。

### 风险等级
- **中-高**

### 建议
- 统一云函数命名、目录与逻辑匹配关系。
- 制定统一的云函数返回结构规范（如 `code/message/data`）。
- 环境配置统一从配置文件读取，避免硬编码。

---

## 三、核心模块深度诊断

## 1) 登录逻辑（wx.login / token / 会话）
### 关键问题
- **登录态只依赖本地 token，不做服务端校验**  
  - 位置：`app.js` 中 `checkLoginStatus`  
  - 风险：本地 token 可伪造/长期有效，存在越权与伪登录风险。
- **失败递归重试无上限**  
  - 位置：`app.js` 中 `getWXContext`  
  - 风险：云端异常时可能无限递归，导致卡死或爆栈。
- **token 生成口径不统一**  
  - 云函数生成：`cloudfunctions/user-login/index.js`  
  - 前端自造：`pages/user/profile/profile.js`  
  - 风险：鉴权失效或 token 无意义。
- **用户数据集合命名混乱**  
  - 使用集合：`shop_user`、`userInfo`、`user`、`users`  
  - 风险：用户信息分裂、读写错表。

### 严重程度
- **高**

### 建议
- token 必须由云端签发与校验，前端不应生成。
- 登录态应加入过期校验或定期刷新机制。
- 统一用户集合名称与字段结构。

---

## 2) 支付逻辑（发起支付 / 参数构造 / 支付状态）
### 关键问题
- **订单状态更新参数命名不一致**  
  - 前端传 `openid`：`pages/pay/pay.js`  
  - 云函数期望 `openId`：`cloudfunctions/updateOrderStatus/index.js`  
  - 风险：支付完成后状态无法更新。
- **库存可能被重复锁定/扣减**  
  - `order-createOrder` 与 `payOrder` 均含库存变更逻辑  
  - 风险：库存错误或出现负库存。
- **支付阶段订单归属字段不一致**  
  - `payOrder` 查询使用 `openid`  
  - 订单存储字段是 `openId`  
  - 风险：订单查不到 → 支付失败。

### 严重程度
- **高**

### 建议
- 统一 `openId/openid` 字段命名与使用。
- 库存逻辑明确“锁库存”和“扣库存”的唯一触发点，避免重复执行。
- 支付前订单查询与创建字段保持一致。

---

## 3) 订单查看（订单列表 / 详情 / 状态展示）
### 关键问题
- **订单列表返回结构不一致导致前端误判失败**  
  - `cloudfunctions/getOrders/index.js` 返回 `{success:true}`  
  - `pages/my-orders/my-orders.js` 期望 `code === 0`
- **订单详情查询条件字段不一致**  
  - `getOrderById` 使用 `openid`，订单实际为 `openId`
- **订单详情支付跳转路径错误**  
  - `pages/order/detail/detail.js` 跳转 `/pages/payment/payment`，项目实际为 `/pages/pay/pay`
- **确认收货云函数命名不一致**  
  - 页面调用 `confirmOrder`  
  - 实际函数为 `confirmReceipt`

### 严重程度
- **中-高**

### 建议
- 统一订单 API 的返回结构与前端判定逻辑。
- 修正跳转路径与函数名称的映射关系。
- 统一订单字段 `openId`。

---

## 4) 支付回调（回调处理 / 订单更新 / 异常处理）
### 关键问题
- **支付密钥硬编码**  
  - `cloudfunctions/pay-notify/index.js`、`cloudfunctions/refund-notify/index.js`  
  - 风险：密钥泄露，极高安全风险。
- **验签方式疑似不符合 V3 标准**  
  - 目前使用 HMAC + APIv3Key  
  - 风险：验签误判或被绕过。
- **异常仍返回成功**  
  - `pay-notify` 捕获异常仍返回 SUCCESS  
  - 风险：失败订单不会重试通知，导致永久错误状态。
- **退款回调异常返回 FAIL**  
  - `refund-notify` 异常直接 500  
  - 风险：微信重复通知，可能重复处理。

### 严重程度
- **高**

### 建议
- 所有密钥迁移到云函数环境变量或密钥服务管理。
- 严格按微信支付 V3 规范验签。
- 支付回调异常时应返回 FAIL，让微信重试。

---

## 5) 商品显示（列表 / 详情 / 渲染 / 加载）
### 关键问题
- **重复函数定义，逻辑被覆盖**  
  - `pages/shop/detail/detail.js` 中 `decreaseQuantity` 重复定义
- **商品详情接口重复且字段结构不一致**  
  - `product-getProduct` / `product-getProductDetail`  
  - 字段 `cover_image` 与 `cover-image` 混用

### 严重程度
- **中**

### 建议
- 合并商品详情接口，统一字段结构。
- 删除重复函数定义，避免隐藏 bug。

---

## 四、云函数调用与封装检查
### 问题
- `wx.cloud.callFunction` 分散在页面中，缺少统一封装（虽然存在 `utils/request.js`，但未全量使用）。
- 云函数返回结构不统一导致前端判断逻辑复杂、错误率高。

### 风险等级
- **中**

### 建议
- 强制所有调用走统一封装函数，并统一返回结构。
- 云函数统一错误码、错误信息格式。

---

## 五、异常处理与稳定性风险
### 问题
- 多处异步流程缺少 `try/catch` 或失败兜底策略。
- 登录与支付关键流程中存在“错误仍继续”的隐性漏洞。

### 风险等级
- **中-高**

### 建议
- 关键流程统一使用 `try/catch`，失败必须显式提示并中断。
- 增加统一错误处理与日志上报。

---

## 六、优先级问题清单（建议修复顺序）

### P0（必须立即处理）
- **支付回调密钥硬编码**（`pay-notify`、`refund-notify`）  
- **订单字段 `openId/openid` 不一致**（订单创建/查询/支付）  
- **支付回调异常仍返回 SUCCESS**（导致状态永久错误）

### P1（高优先级）
- **云函数返回结构不统一**（影响多页面）  
- **订单云函数命名与内容错位**  
- **支付与库存逻辑重复执行**

### P2（中优先级）
- **跳转路径错误 / 页面不存在**  
- **商品详情接口重复与字段不统一**  
- **重复函数定义、代码冗余**

---

## 七、总体优化建议
- 统一数据模型：用户、订单、商品字段命名全局一致。  
- 统一接口规范：返回统一的 `code/message/data`。  
- 支付模块提升安全级别：密钥管理 + 验签规范化。  
- 引入统一错误处理与日志监控机制。

---

### 结束语
本报告为**纯诊断**输出，未做任何改动。如需我基于本报告**生成整改清单**、**修复优先级表**或**逐文件修复建议**，可继续告诉我范围与方式。