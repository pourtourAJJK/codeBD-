文档基本信息
项目	内容
文档名称	富硒地带用户端小程序登录与地址引导流程改造需求文档
项目名称	富硒地带O2O饮用水电商小程序
目标用户	普通消费者（小程序用户端）
开发框架	微信小程序原生框架 + 云开发（CloudBase）
版本号	V1.0
日期	2025-02-17
1. 项目背景与目标
1.1 项目背景
富硒地带是一款面向普通消费者的O2O饮用水电商小程序，目前已具备首页、分类、购物车、我的等基础页面。现有界面已完成视觉设计（科技蓝+促销橙配色、卡片式布局、圆角控件），但尚未实现完整的用户登录与地址管理流程。

1.2 核心流程目标
在保持现有界面风格不变的前提下，实现如下登录与引导逻辑：

浏览免登：用户进入首页、分类时，无需登录即可正常浏览所有内容。

操作触发登录：当用户点击「购物车」或「我的」时，触发完整的登录与地址引导流程。

流程闭环：登录成功后，若用户无收货地址则引导至新增地址页；已有地址则直接进入目标页（购物车/我的）。

1.3 关键状态定义
状态	存储方式	校验时机
登录态（openid/token）	wx.setStorageSync('openid', value)	每次点击购物车/我的时
手机号绑定状态	云数据库用户表字段 phone	静默登录成功后
地址列表	云数据库地址表，关联openid	手机号绑定成功后
2. 业务流程设计
2.1 整体流程图
text
用户点击「购物车」/「我的」
        ↓
检查本地存储 openid/token
        ↓
是否存在有效登录态？───否──→ 跳转「授权登录页」
        ↓是                      ↓
    wx.checkSession()       用户点击「授权登录」
        ↓                      wx.login()获取code
   登录态是否过期？──是─→ 调用云函数 user-login
        ↓否                      ↓
   直接进入目标页         获取openid并存储
        ↓                      ↓
   流程结束              跳转「手机号绑定页」
                              ↓
                        用户授权手机号
                              ↓
                        云函数解密绑定
                              ↓
                        检查用户是否有地址
                              ↓
                        有地址？──是──→ 跳转目标页
                              ↓否
                        跳转「新增地址页」
                              ↓
                        用户填写保存地址
                              ↓
                        跳转目标页
2.2 登录态管理机制
参考小程序登录态管理的最佳实践，需在每次网络请求中自动处理登录态校验 。

登录态校验流程图 ：

text
发起请求
    ↓
检查是否执行过checkSession？──否──→ 调用wx.checkSession()
    ↓是                            ↓
    ↓                     登录态是否过期？──是──→ 执行重新登录
    ↓否                           ↓否
    ↓                     尝试获取本地session
    ↓                            ↓
    ↓                     本地session存在？──否──→ 执行登录
    ↓是                           ↓是
发起带session的业务请求
    ↓
解析返回数据
    ↓
数据返回成功？──否──→ 若发现登录态失效，重新登录后重试
    ↓是
业务处理完成
3. 界面改造点
3.1 现有页面改造
3.1.1 购物车页面
文件路径：pages/cart/index

生命周期：onLoad / onShow

改造内容：

javascript
onShow() {
  // 增加登录态校验
  if (!this.checkLoginStatus()) {
    // 未登录，跳转授权登录页，并记录目标页
    wx.setStorageSync('targetPage', 'cart');
    wx.navigateTo({ url: '/pages/login/index' });
    return;
  }
  // 已登录，正常加载购物车数据
  this.loadCartData();
}
3.1.2 我的页面
文件路径：pages/user/index

改造内容：同上，目标页记录为 user

3.2 新增页面设计
3.2.1 授权登录页（图二）
页面标识：/pages/login/index

顶部导航栏：

左侧：返回箭头

标题：「好物到家」

中部内容：

预置图片（随机/品牌形象图）

品牌名称：「富硒地带」

Slogan：「富硒地带 好物到家」

底部按钮：

绿色「授权登录」按钮（大圆角，带轻微渐变）

页面逻辑：

检查本地存储中是否存在有效 openid，若存在则直接跳转后续流程 

按钮点击事件：调用 wx.login() 获取code，调用云函数获取openid

3.2.2 手机号绑定页（图三）
页面标识：/pages/bind-phone/index

顶部导航栏：

左侧：返回箭头

标题：「绑定手机号」

中部内容：

提示文案：「为了更好的购物体验，请绑定手机号」

微信官方手机号授权按钮：

html
<button 
  open-type="getPhoneNumber" 
  @getphonenumber="handleGetPhoneNumber"
  class="phone-btn"
>
  手机号快捷登录
</button>
「暂不绑定」链接（点击后返回上一页）

样式要求：

按钮采用主色科技蓝（#33B5FF）或促销橙（#FF6B2B），大圆角设计

与现有界面字体、间距保持一致

注意事项：

调用此组件前必须已执行 wx.login() 

用户拒绝授权时，errMsg 返回 'getPhoneNumber:fail user deny'，需给出友好提示 

3.2.3 新增地址页（图五）
页面标识：/pages/address/add

顶部导航栏：

左侧：返回箭头

标题：「新增收货地址」

表单内容：

收货人（输入框）

联系电话（输入框，数字键盘）

所在地区（三级联动选择器）

门牌号（输入框）

设为默认地址（开关组件）

底部按钮：

「保存地址」按钮（橙色填充，大圆角）

页面逻辑：

表单提交后，调用云函数 addAddress 存储地址信息 

若勾选「设为默认地址」，需将其他地址的默认状态置为false 

保存成功后，跳转回用户最初点击的目标页（购物车/我的）